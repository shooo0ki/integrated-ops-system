# M3-04 アサイン管理 — 要件定義 v1

## 機能要件

| 優先度 | 要件 |
|--------|------|
| Must | PJ のポジションを選択し、メンバーをアサイン登録できる（期間・月間想定工数を入力） |
| Must | 既存アサインを解除（終了日を設定）できる |
| Must | 同一 PJ・同一ポジションへの重複アサインを拒否する |
| Must | 月間工数が 0 以下の場合はバリデーションエラーを表示する |
| Must | メンバー候補テーブルにスキル充足状況（充足 / 不足）と現在のアサイン先・月間工数合計を表示する |
| Must | スキルフィルタートグルで要件充足メンバーのみ / 全員 を切り替えられる（制約ではなくフィルター） |
| Must | 管理者は全 PJ のアサイン管理ができる |
| Must | マネージャーは担当 PJ のみアサイン管理できる |
| Must | 社員・インターンはアクセス不可（403） |
| Should | ポジションタブで切り替えて各ポジションのアサイン状況を表示する |
| Should | 選択ポジションの必要スキル要件を画面内に表示する |

## 受け入れ条件（Acceptance Criteria）

- [ ] 管理者がメンバー・ポジション・工数・開始日を入力してアサインを登録できる
- [ ] 同一 PJ・同一ポジションへの重複アサインで「このメンバーはすでにこのポジションにアサイン済みです」が表示される
- [ ] 月間工数 0 を入力すると「工数は 1 時間以上を入力してください」が表示される
- [ ] スキルフィルター ON で要件充足メンバーのみ候補に表示される（フィルター OFF で全員表示）
- [ ] メンバー候補テーブルにスキル充足（✅）/ 不足（⚠️）が表示される
- [ ] 既存アサインの「解除」で終了日が設定されてアサインが終了する
- [ ] マネージャーが担当外 PJ のアサイン管理にアクセスすると 403 が返る

## データ要件

| エンティティ | 項目 | 制約 |
|------------|------|------|
| `PROJECT_ASSIGNMENT` | id, project_id, member_id, position_id, workload_hours, start_date, end_date | workload_hours: 1 以上 |
| `PROJECT_POSITION` | id, project_id, name | ポジション一覧 |
| `POSITION_REQUIRED_SKILL` | position_id, skill_id, min_level | 必要スキル要件 |
| `MEMBER_SKILL` | member_id, skill_id, level | スキル充足判定 |
| `MEMBER` | id, name | 候補テーブル |

スキル充足判定: `MEMBER_SKILL.level >= POSITION_REQUIRED_SKILL.min_level` をスキルごとに判定。全スキルが充足 → ✅、1 つでも不足 → ⚠️（不足スキルとレベル差を表示）

現在の月間工数合計: アクティブな `PROJECT_ASSIGNMENT.workload_hours` の合計（当該メンバーの全 PJ）

## 非機能要件（暫定）

| 区分 | 内容 |
|------|------|
| 性能 | アサイン登録 API 応答 200ms 以内 |
| セキュリティ | 認証必須。マネージャーの担当外 PJ 操作はサーバー側で拒否 |
| 監査 | アサイン登録・解除を「誰が・いつ・対象メンバー・ポジション・工数」で監査ログに記録 |
| ログ | 重複アサイン検出・DB エラーをサーバーログに記録 |

## 想定エラーと対処

| エラー条件 | 表示 / 挙動 | 対処方針 |
|-----------|------------|---------|
| 重複アサイン | 「このメンバーはすでにこのポジションにアサイン済みです」 | 登録を中断 |
| 月間工数が 0 以下 | 「工数は 1 時間以上を入力してください」 | 登録を中断 |
| 権限外 PJ へのアクセス | 403 | — |
| DB 保存失敗 | 「保存に失敗しました。再度お試しください。」 | サーバーエラーログ記録 |
