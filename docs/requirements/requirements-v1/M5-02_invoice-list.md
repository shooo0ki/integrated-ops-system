# M5-02 請求書一覧 — 要件定義 v1

## 機能要件

| 優先度 | 要件 |
|--------|------|
| Must | 請求書一覧を表示する（請求書番号・対象年月・氏名・勤務時間合計・請求金額・発行日・Slack 送付状態） |
| Must | 対象月でフィルタリングできる |
| Must | 管理者はメンバーでもフィルタリングできる |
| Must | Excel ファイル（.xlsx）をダウンロードできる |
| Must | 管理者は勤怠修正後に請求書を再生成できる |
| Must | Slack DM で再送信できる |
| Must | 管理者は全員分の請求書を閲覧・ダウンロード・再生成できる |
| Must | インターン・社員は自分の請求書のみ閲覧・ダウンロードできる（再生成は不可） |
| Must | 時給単価は管理者のみ表示する |
| Should | 請求書番号のフォーマットは `YYYY-MM-{3桁連番}` とし、月単位でリセットする |

## 受け入れ条件（Acceptance Criteria）

- [ ] インターンでアクセスすると自分の請求書のみ表示される
- [ ] 管理者でアクセスすると全員分の請求書が表示される
- [ ] 「ダウンロード」で .xlsx ファイルがダウンロードされる
- [ ] ファイルが存在しない場合「請求書が見つかりません。再生成してください」が表示される
- [ ] 管理者が「再生成」すると最新の勤怠データで請求書が更新される
- [ ] 「Slack 再送」でインターン本人の Slack DM に請求書通知が送信される
- [ ] Slack 再送失敗時にエラートーストが表示される
- [ ] 時給単価の列は管理者のみ表示される
- [ ] 請求書番号が `2026-03-001` の形式で表示される

## データ要件

| エンティティ | 項目 | 制約 |
|------------|------|------|
| `INVOICE` | id, invoice_number, member_id, target_month, work_hours_total, unit_price, amount_excl_tax, amount_incl_tax, issued_at, file_path, slack_sent_at | — |
| `MEMBER` | id, name, salary_amount | 時給単価表示用 |
| `ATTENDANCE` | work_minutes | 再生成時の勤怠データ |

請求書番号採番ルール: `YYYY-MM-{001〜}` 当月内の生成順で採番、翌月になると 001 からリセット

消費税率: 10%（固定）
- 税抜金額 = 合計実働時間（h）× 時給単価
- 税込金額 = 税抜金額 × 1.1

請求書（xlsx）に含める最低限の項目: 氏名・対象月・勤務日数・勤務時間合計・時給単価・税抜金額・消費税・税込金額・口座情報

## 非機能要件（暫定）

| 区分 | 内容 |
|------|------|
| 性能 | ダウンロード応答 3 秒以内 |
| セキュリティ | 認証必須。他メンバーの請求書 URL への直接アクセスはサーバー側で拒否 |
| 監査 | ダウンロード・再生成・Slack 送信を「誰が・いつ・対象請求書」で監査ログに記録 |
| ログ | ファイル生成失敗・Slack 送信失敗をサーバーログに記録 |

## 想定エラーと対処

| エラー条件 | 表示 / 挙動 | 対処方針 |
|-----------|------------|---------|
| ファイルが存在しない | 「請求書が見つかりません。再生成してください」 | 再生成ボタンを表示 |
| Slack 再送失敗 | エラートースト | 手動でのダウンロード・送付を案内 |
| 再生成失敗 | 「請求書の生成に失敗しました。再度お試しください。」 | サーバーエラーログ記録 |
| 権限外の請求書への直接アクセス | 403 | — |
