# M6-03 キャッシュフロー管理 — 要件定義 v1

## 機能要件

| 優先度 | 要件 |
|--------|------|
| Must | 対象月を選択し、キャッシュイン（クライアント入金・その他入金）とキャッシュアウト（給与支払い・外注費・固定費・その他支出）を管理する |
| Must | 給与支払い（キャッシュアウト）は請求書確定額から自動計算する |
| Must | その他の各項目は手動入力できる |
| Must | 月次収支（キャッシュイン合計 − キャッシュアウト合計）を自動計算する |
| Must | 月末残高（前月残高 + 月次収支）を自動計算する |
| Must | 初回のみ前月繰越残高を必須入力として設定する |
| Must | 月次残高推移グラフを表示する |
| Must | 管理者以外はアクセス不可（403） |
| Should | 前月・翌月ナビゲーションで月を切り替えられる |
| Should | 各項目に備考を入力できる（最大 200 文字） |

## 受け入れ条件（Acceptance Criteria）

- [ ] 管理者でアクセスすると当月のキャッシュフロー画面が表示される
- [ ] 管理者以外でアクセスすると 403 が返る
- [ ] クライアント入金を入力して保存すると月次収支・月末残高が自動更新される
- [ ] 給与支払い欄が請求書確定額の合計で自動表示される
- [ ] 初回アクセス時（前月残高未設定）に「前月残高を入力してください（初回設定）」が表示される
- [ ] 月次残高推移グラフが表示される
- [ ] 備考に 200 文字を超えた文字を入力するとバリデーションエラーが表示される

## データ要件

| エンティティ | 項目 | 備考 |
|------------|------|------|
| `PL_RECORD` (CF区分) | id, target_month, cf_category (CASH_IN/CASH_OUT), cf_item, amount, memo | 手動入力部分 |
| `INVOICE` | amount_incl_tax, target_month | 給与支払い自動計算用（確定済み請求書の合計） |

キャッシュフロー項目定義:
| 区分 | 項目 | 入力方式 |
|------|------|---------|
| キャッシュイン | クライアント入金 | 手動 |
| キャッシュイン | その他入金 | 手動 |
| キャッシュアウト | 給与支払い | 自動（確定請求書合計） |
| キャッシュアウト | 外注費支払い | 手動 |
| キャッシュアウト | 固定費 | 手動 |
| キャッシュアウト | その他支出 | 手動 |

前月残高の引き継ぎ: 前月の `月末残高` を当月の `前月繰越残高` として自動セット（初月のみ手動入力）

## 非機能要件（暫定）

| 区分 | 内容 |
|------|------|
| 性能 | データ表示 3 秒以内 |
| セキュリティ | 管理者ロールのみアクセス可（サーバー側検証） |
| 監査 | 金額の変更を「誰が・いつ・項目・変更前後の値」で監査ログに記録 |
| ログ | DB エラーをサーバーログに記録 |

## 想定エラーと対処

| エラー条件 | 表示 / 挙動 | 対処方針 |
|-----------|------------|---------|
| 前月残高未設定（初回） | 「前月残高を入力してください（初回設定）」 | 入力フォームにフォーカス |
| 備考が 200 文字超 | 「備考は 200 文字以内で入力してください」 | 保存を中断 |
| DB 保存失敗 | 「保存に失敗しました。再度お試しください。」 | サーバーエラーログ記録 |
| 権限外アクセス | 403 | — |
