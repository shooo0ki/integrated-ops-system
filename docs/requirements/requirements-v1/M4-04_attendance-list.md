# M4-04 勤怠一覧 — 要件定義 v1

## 機能要件

| 優先度 | 要件 |
|--------|------|
| Must | 対象月・対象メンバーの日別勤怠テーブルを表示する（出勤/退勤時刻・休憩時間・実働時間・日報・状態） |
| Must | 月次サマリー（勤務日数・合計実働時間・時給単価・給与見込み）を表示する（時給単価・給与見込みは管理者と本人のみ） |
| Must | インターンが「OK」ボタンで当月勤怠を「確認済み」にマークできる |
| Must | 社員が修正依頼（コメント付き）を管理者へ送れる |
| Must | インターンも同様に修正依頼（コメント付き）を管理者へ送れる |
| Must | 管理者は出退勤時刻・休憩時間を直接編集できる |
| Must | 管理者・マネージャー（担当 PJ のみ）が勤怠を承認できる |
| Must | 承認済みの勤怠は管理者以外は修正できない |
| Must | 打刻漏れ日は行をオレンジ強調する |
| Must | 管理者は打刻漏れ日に勤怠を手動登録できる |
| Should | 前月・翌月のナビゲーションで月を切り替えられる |
| Should | 承認状態バッジ（未確認 / 確認済 / 承認済）を表示する |

## 受け入れ条件（Acceptance Criteria）

- [ ] インターンでアクセスすると自分の勤怠一覧が表示される
- [ ] 「OK」ボタンで当月勤怠が「確認済み」になる
- [ ] 社員が修正依頼（コメント付き）を送れる
- [ ] インターンが修正依頼（コメント付き）を送れる
- [ ] 管理者が出退勤時刻を編集して保存できる
- [ ] 管理者が勤怠を承認すると承認済みバッジが表示される
- [ ] 承認済みの勤怠を本人が修正しようとすると「承認済みの勤怠は修正できません。管理者にお問い合わせください」が表示される
- [ ] 打刻漏れ日がオレンジ強調される
- [ ] 管理者に時給単価・給与見込みが表示される
- [ ] 社員でアクセスすると時給単価・給与見込みが表示される（本人分のみ）
- [ ] マネージャーでアクセスすると担当 PJ メンバーの勤怠が表示される

## データ要件

| エンティティ | 項目 | 備考 |
|------------|------|------|
| `ATTENDANCE` | member_id, date, clock_in, clock_out, break_minutes, work_minutes, done_today, status, confirmed_at, approved_at | 日別テーブル |
| `MEMBER` | id, name, salary_type, salary_amount | 月次サマリー用 |

月次サマリー計算:
- 勤務日数 = `ATTENDANCE` のレコード数（当該月）
- 合計実働時間 = `work_minutes` の合計
- 給与見込み = 合計実働時間（時間換算）× `salary_amount`（時給制の場合）

承認状態遷移: 未確認 → 確認済（インターンが OK） → 承認済（管理者/マネージャーが承認）

修正依頼はコメントを `ATTENDANCE` に紐づけて保存し、管理者への通知を行う（Slack またはシステム通知）。

## 非機能要件（暫定）

| 区分 | 内容 |
|------|------|
| 性能 | 一覧表示 3 秒以内（月 31 日分） |
| セキュリティ | 認証必須。他メンバーの勤怠参照はサーバー側でロール検証。時給・給与情報は権限者のみ API レスポンスに含める |
| 監査 | 勤怠の編集・確認・承認操作を「誰が・いつ・対象・変更前後」で監査ログに記録 |
| ログ | 承認済み勤怠への不正変更試みをサーバーログに記録 |

## 想定エラーと対処

| エラー条件 | 表示 / 挙動 | 対処方針 |
|-----------|------------|---------|
| 承認済みの勤怠修正 | 「承認済みの勤怠は修正できません。管理者にお問い合わせください」 | 修正を中断 |
| 打刻漏れ日 | 行をオレンジ強調 | 管理者が手動登録で対応 |
| DB 保存失敗 | 「保存に失敗しました。再度お試しください。」 | サーバーエラーログ記録 |
