# C-03 設定画面 — 要件定義 v1

## 機能要件

| 優先度 | 要件 |
|--------|------|
| Must | Slack Webhook URL・勤怠通知チャンネル・月末締め通知日を登録・更新できる |
| Must | 会社名（親会社・子会社）を登録・更新できる |
| Must | 保存ボタンで設定値を DB に書き込む |
| Must | 「Slack 接続テスト」ボタンで Webhook にテストメッセージを送信し、疎通確認結果を画面に表示する |
| Must | 管理者以外はこの画面にアクセスできない（404 または権限エラーを返す） |
| Should | タブ UI で「Slack 連携設定」「会社情報」「ロール・権限設定（将来拡張）」「システム情報」を切り替え表示する |
| Could | ロール・権限設定タブを将来拡張として UI スロットのみ確保する（v1 では空実装可） |

## 受け入れ条件（Acceptance Criteria）

- [ ] 管理者でログインすると設定画面にアクセスできる
- [ ] 管理者以外でアクセスすると 403 が返る
- [ ] Webhook URL を保存すると DB に反映される
- [ ] Slack 接続テストが成功すると「接続に成功しました」が表示される
- [ ] Slack 接続テストが失敗すると「Slack への接続に失敗しました。URL を確認してください」が表示される
- [ ] 不正な形式の Webhook URL 入力時は「有効な Slack Webhook URL を入力してください」バリデーションが表示される
- [ ] 月末締め通知日に 1〜28 以外の値を入力するとバリデーションエラーが表示される
- [ ] 会社名（親会社）が空の場合バリデーションエラーが表示される

## データ要件

| エンティティ | 項目 | 制約 |
|------------|------|------|
| `SYSTEM_CONFIG` | key (文字列) | 一意、最大 100 文字 |
| `SYSTEM_CONFIG` | value (文字列) | 暗号化必要なフィールド（Webhook URL 等）と平文フィールドを区別 |
| `SYSTEM_CONFIG` | updated_at | 更新日時 |
| `SYSTEM_CONFIG` | updated_by | 更新者 user_id |

設定キー定義（最低限）:
- `slack_webhook_url`
- `slack_attendance_channel`
- `monthly_closing_notify_day`
- `company_name_parent`
- `company_name_child`

## 非機能要件（暫定）

| 区分 | 内容 |
|------|------|
| 性能 | 設定保存 API 応答 200ms 以内 |
| セキュリティ | 管理者ロールのみアクセス可（サーバー側でロール検証）。Webhook URL はログ出力しない |
| 監査 | 設定変更のたびに「どのキーを・誰が・いつ変更したか」を監査ログに記録 |
| ログ | Slack 接続テスト失敗のエラー詳細をサーバーログに記録 |

## 想定エラーと対処

| エラー条件 | 表示 / 挙動 | 対処方針 |
|-----------|------------|---------|
| Webhook URL 不正形式 | 「有効な Slack Webhook URL を入力してください」 | 保存処理を実行しない |
| Slack テスト送信失敗 | 「Slack への接続に失敗しました。URL を確認してください」 | 設定値はそのまま保持 |
| 必須項目が空 | 各項目に「入力してください」を表示 | 保存処理を実行しない |
| 月末締め通知日が範囲外 | 「1〜28 の整数を入力してください」 | 保存処理を実行しない |
| DB 保存失敗 | 「設定の保存に失敗しました。再度お試しください。」 | サーバーエラーログ記録 |
