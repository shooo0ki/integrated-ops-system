# M6-01 PJ 別 PL — 要件定義 v1

## 機能要件

| 優先度 | 要件 |
|--------|------|
| Must | PJ・対象月を選択し、月次損益テーブル（売上・コスト・粗利・粗利率）を表示する |
| Must | 月額契約売上・追加売上・外注費・その他経費を手動入力できる |
| Must | 月額固定メンバーの人件費を自動計算する（月額報酬 × 当該 PJ 工数 / 全 PJ 合計工数） |
| Must | 時給制メンバーの人件費を自動計算する（勤怠実績時間 × 時給） |
| Must | 粗利 = 売上合計 − コスト合計、粗利率 = 粗利 / 売上合計 を自動計算する |
| Must | 管理者は全 PJ を閲覧・入力できる |
| Must | マネージャーは担当 PJ のみ閲覧・入力できる |
| Must | 社員・インターンはアクセス不可（403） |
| Must | 勤怠未集計の月の人件費には警告メッセージを表示する |
| Should | 月次推移グラフ（売上・コスト・粗利の折れ線）を表示する |
| Should | 前月・翌月ナビゲーションで月を切り替えられる |

## 受け入れ条件（Acceptance Criteria）

- [ ] 管理者が売上・コストを入力して保存すると PL が更新される
- [ ] 月額固定メンバーの人件費が `月額報酬 × (当該PJ工数 / 全PJ合計工数)` で自動計算される
- [ ] 時給制メンバーの人件費が `勤怠実績時間 × 時給` で自動計算される
- [ ] 粗利・粗利率が自動計算される
- [ ] 勤怠未集計月にアクセスすると「勤怠データが未集計です。M5-01 で集計後に確認してください」が表示される
- [ ] マネージャーが担当外 PJ の PL にアクセスすると 403 が返る
- [ ] 社員でアクセスすると 403 が返る

## データ要件

| エンティティ | 項目 | 備考 |
|------------|------|------|
| `PL_RECORD` | id, project_id, target_month, revenue_contract, revenue_extra, cost_outsourcing, cost_other, created_by, updated_at | 手動入力値 |
| `PROJECT_ASSIGNMENT` | member_id, project_id, workload_hours | 工数比率計算用 |
| `MEMBER` | id, salary_type, salary_amount | 人件費計算用 |
| `ATTENDANCE` | member_id, date, work_minutes | 時給制人件費（勤怠集計後） |

月額固定メンバー人件費の計算:
```
全アサイン工数合計 = Σ(当月アクティブな PROJECT_ASSIGNMENT.workload_hours)
当該PJの按分率 = 当該PJ工数 / 全アサイン工数合計
人件費 = 月額報酬 × 按分率
```

## 非機能要件（暫定）

| 区分 | 内容 |
|------|------|
| 性能 | PL データ表示 3 秒以内 |
| セキュリティ | 認証必須。マネージャーの担当外 PJ アクセスはサーバー側で拒否 |
| 監査 | PL 手動入力の変更を「誰が・いつ・項目・変更前後の値」で監査ログに記録 |
| ログ | 計算エラー・DB エラーをサーバーログに記録 |

## 想定エラーと対処

| エラー条件 | 表示 / 挙動 | 対処方針 |
|-----------|------------|---------|
| 勤怠未集計月 | 「勤怠データが未集計です。M5-01 で集計後に確認してください」 | 人件費セルに「未集計」表示 |
| 売上が 0 の場合の粗利率 | 「—」を表示（ゼロ除算回避） | — |
| DB 保存失敗 | 「保存に失敗しました。再度お試しください。」 | サーバーエラーログ記録 |
| 権限外アクセス | 403 | — |
