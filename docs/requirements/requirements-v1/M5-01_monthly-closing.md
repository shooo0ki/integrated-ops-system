# M5-01 月末締め管理 — 要件定義 v1

## 機能要件

| 優先度 | 要件 |
|--------|------|
| Must | 時給制メンバー一覧と確認状況（未送信 / 確認待ち / 確認済 / 修正依頼中）を表示する |
| Must | 「集計実行」で当月の全勤怠データを集計して給与を計算する |
| Must | 未打刻日ありで集計実行しようとすると警告ダイアログを表示する |
| Must | 「Slack 確認依頼送信」で未確認メンバーへ Slack メンション付き確認依頼を一括送信する |
| Must | 個別に再通知できる |
| Must | 「強制確定」で未確認メンバーを強制的に確認済みとし請求書生成へ進められる |
| Must | 確認済みメンバー全員の請求書を一括生成できる |
| Must | 管理者以外はアクセス不可（403） |
| Should | 請求書生成状態（未生成 / 生成済 / 送付済）を一覧に表示する |
| Should | 未打刻日数が 0 件以外の行をオレンジ強調する |

## 受け入れ条件（Acceptance Criteria）

- [ ] 管理者でアクセスすると時給制メンバー一覧と確認状況が表示される
- [ ] 管理者以外でアクセスすると 403 が返る
- [ ] 「集計実行」で全メンバーの勤務時間と給与見込みが計算される
- [ ] 未打刻日ありで集計実行すると「X 名に未打刻日があります。このまま集計しますか？」のダイアログが表示される
- [ ] 「Slack 確認依頼送信」で未確認メンバー全員に Slack メンションが送信される
- [ ] Slack 送信失敗時にエラートーストと個別再送ボタンが表示される
- [ ] 「強制確定」で指定メンバーが確認済みになる
- [ ] 確認済みメンバーの「請求書生成」で M5-02 の請求書レコードが作成される

## データ要件

| エンティティ | 項目 | 備考 |
|------------|------|------|
| `ATTENDANCE` | member_id, date, work_minutes, status, confirmed_at | 集計対象 |
| `MEMBER` | id, name, salary_type, salary_amount | 時給制メンバーのみ表示 |
| `INVOICE` | id, member_id, target_month, status | 請求書生成状態管理 |

確認状態遷移:
- 未送信 → 確認待ち（Slack 通知後）→ 確認済み（本人 OK）/ 修正依頼中（本人が依頼）

Slack 通知テンプレート（確認依頼）:
```
@[氏名]さん 今月の勤怠を確認してください
勤務日数: X日 / 合計時間: Y時間 / 給与見込: Z円
確認はこちら: [M4-04 へのリンク]
```

## 非機能要件（暫定）

| 区分 | 内容 |
|------|------|
| 性能 | 集計実行は 30 秒以内（バックグラウンド処理推奨、進捗表示付き） |
| セキュリティ | 管理者ロールのみアクセス可（サーバー側検証） |
| 監査 | 集計実行・強制確定・請求書生成操作を「誰が・いつ・対象月」で監査ログに記録 |
| ログ | Slack 送信失敗・集計エラーをサーバーログに記録 |

## 想定エラーと対処

| エラー条件 | 表示 / 挙動 | 対処方針 |
|-----------|------------|---------|
| 未打刻日ありで集計実行 | 「X 名に未打刻日があります。このまま集計しますか？」ダイアログ | ユーザーが続行 or キャンセルを選択 |
| Slack 送信失敗 | エラートースト + 個別再送ボタン | 再送ボタンで特定メンバーのみ再試行 |
| 集計処理失敗 | 「集計処理に失敗しました。再度お試しください。」 | サーバーエラーログ記録 |
| 権限外アクセス | 403 | — |
