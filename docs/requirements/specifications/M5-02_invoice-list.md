# M5-02 請求書管理

## 目的
時給制メンバー（インターン・業務委託等）が自分で月次請求書を生成し、手動で提出する。
管理者は誰が請求書を未提出かを一覧で確認できる。

> **設計メモ（旧仕様からの変更点）**:
> - 請求書は管理者が発行するのではなく、**雇われている側（メンバー本人）が生成・送付**する。
> - 自動送信は行わない（**手動送信のみ**）。
> - 請求書生成時に**交通費・その他経費**を入力できる。
> - 管理者は未送付者を把握できるダッシュボードを持つ。

## 対象ペルソナ / シナリオ
- 山田（インターン）: 月末に自分の請求書を生成・経費入力・PDF/Excel ダウンロード・手動提出
- 佐藤（管理者）: 月次の請求書提出状況確認・未提出者の把握

---

## 画面 A: 自分の請求書一覧（全メンバー）

### UI 構成
- 対象月フィルター
- 自分の請求書一覧テーブル
- 「請求書を生成する」ボタン（対象月が未生成の場合）
- ダウンロードボタン

### 請求書生成フォーム
生成ボタン押下後にモーダルまたはサブページで以下を入力:

| 項目 | 必須 | 制約 | 例 |
|------|------|------|----|
| 対象月 | 必須 | YYYY-MM | `2026-02` |
| 勤務日数・時間 | 自動 | 勤怠データから自動集計（編集不可） | — |
| 時給単価 | 自動 | 契約データから取得（編集不可） | `1,500` |
| 交通費 | 任意 | 0 以上の整数（円）。日付・区間・金額を明細入力可 | `3,200` |
| その他経費 | 任意 | 0 以上の整数（円）。備考入力可 | `1,000` |
| 備考 | 任意 | 最大 500 文字 | — |

#### 金額自動計算
```
労働報酬 = 総稼働時間 × 時給
経費合計 = 交通費 + その他経費
請求小計 = 労働報酬 + 経費合計
消費税  = 請求小計 × 税率（10%）
請求合計 = 請求小計 + 消費税
```

### 表示項目（請求書一覧テーブル）
| 項目 | 説明 |
|------|------|
| 対象年月 | — |
| 稼働時間 | — |
| 労働報酬（税抜） | — |
| 経費合計 | — |
| 請求合計（税込） | — |
| 生成日時 | — |
| 送付状態 | **未送付 / 送付済み** |

### 操作
| 操作 | 説明 |
|------|------|
| 請求書を生成する | 経費入力モーダルを開き、生成 |
| ダウンロード（PDF/Excel） | 生成済みファイルをダウンロード |
| 送付済みにする | 手動で「送付済み」にマーク（自動送信なし） |
| 再生成 | 経費を修正して再生成（管理者確認前のみ） |

---

## 画面 B: 請求書提出状況（管理者のみ）

### UI 構成
- 対象月フィルター
- 全メンバーの提出状況一覧テーブル
- 未提出者ハイライト・催促メモ機能

### 表示項目
| 項目 | 説明 |
|------|------|
| 氏名 | — |
| 対象月 | — |
| 稼働時間 | — |
| 請求合計 | — |
| 送付状態 | **未生成 / 生成済（未送付） / 送付済み** |
| 生成日・送付日 | — |

> **設計メモ**: 送付状態が「未生成」または「生成済（未送付）」のメンバーを
> 一目で把握できるよう、行をオレンジ強調表示する。

---

## エラー / 例外
| 条件 | 挙動 |
|------|------|
| 対象月の勤怠が未集計 | 「勤怠データが未集計です。月末締め後に生成してください」 |
| ファイルが存在しない | 「請求書が見つかりません。再生成してください」 |

## 権限（ロール別）
| ロール | 閲覧 | 生成・ダウンロード | 全員分の状況確認 |
|--------|------|-----------------|----------------|
| 管理者 | 全員分 | ○（全員分） | ○ |
| マネージャー | 自分のみ | ○（自分のみ） | — |
| メンバー（社員・インターン共通） | 自分のみ | ○（自分のみ） | — |

## 関連データ（エンティティ）
- `INVOICE`、`INVOICE_EXPENSE`、`MEMBER`、`ATTENDANCE`

## 関連 API
- `GET /api/invoices?month=&memberId=`
- `POST /api/invoices/generate`（勤怠集計 + 経費入力）
- `GET /api/invoices/:id/download`
- `PATCH /api/invoices/:id/status`（送付済みマーク）
- `POST /api/invoices/:id/regenerate`
