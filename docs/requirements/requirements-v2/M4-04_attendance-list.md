# M4-04 勤怠一覧 — 要件定義 v2（確定版）

> 作成日: 2026-02-20 | v1 → v2 更新

---

## v1 からの変更点

| 区分 | 内容 |
|------|------|
| データ要件 | テーブル名・カラム名を物理名に統一。`confirm_status` の ENUM 値を確定 |
| 非機能要件 | 確定値に更新 |
| 運用要件 | セクション新設 |

---

## 機能要件（確定）

| 優先度 | 要件 |
|--------|------|
| Must | 対象月・対象メンバーの日別勤怠テーブルを表示する（出勤/退勤時刻・休憩時間・実働時間・日報・状態） |
| Must | 月次サマリー（勤務日数・合計実働時間・時給単価・給与見込み）を表示する（時給単価・給与見込みは admin・本人のみ） |
| Must | インターンが「OK」ボタンで当月勤怠を `confirm_status = 'confirmed'` にマークできる |
| Must | 社員・インターンが修正依頼（コメント付き）を管理者へ送れる |
| Must | 管理者は出退勤時刻・休憩時間を直接編集できる |
| Must | 管理者・マネージャー（担当 PJ のみ）が勤怠を `confirm_status = 'approved'` に承認できる |
| Must | 承認済みの勤怠は管理者以外は修正できない |
| Must | 打刻漏れ日（`clock_in IS NULL`）の行をオレンジ強調する |
| Must | 管理者は打刻漏れ日に勤怠を手動登録できる |
| Should | 前月・翌月のナビゲーションで月を切り替えられる |
| Should | 承認状態バッジ（未確認 / 確認済 / 承認済）を表示する |

---

## データ要件（確定）

| テーブル | カラム | 備考 |
|---------|--------|------|
| `attendances` | `member_id`, `date`, `clock_in`, `clock_out`, `break_minutes`, `work_minutes`, `done_today`, `status`, `confirm_status` | 日別テーブル |
| `members` | `id`, `name`, `salary_type`, `salary_amount` | 月次サマリー用 |

**confirm_status の状態遷移（確定）:**
```
unconfirmed → confirmed（本人が OK ボタン） → approved（管理者/マネージャーが承認）
```

**月次サマリー計算（確定）:**
- 勤務日数 = `COUNT(attendances)` where `clock_in IS NOT NULL`（当該月）
- 合計実働時間 = `SUM(work_minutes) / 60`（時間単位）
- 給与見込み = 合計実働時間 × `members.salary_amount`（`salary_type = 'hourly'` の場合）

---

## 非機能要件（確定）

| 区分 | 内容 |
|------|------|
| 性能 | 一覧表示 2 秒以内（月 31 日分） |
| セキュリティ | 認証必須。他メンバーの勤怠参照はサーバー側でロール検証。時給・給与情報は権限者のみ API レスポンスに含める |
| 監査 | 勤怠の編集・確認・承認操作を `audit_logs` に記録（action = 'UPDATE'、変更前後の値） |
| ログ | 承認済み勤怠への不正変更試みをサーバーログに `WARN` で記録 |
| 可用性 | 部分的な保存失敗でもエラー行が特定できること |

---

## 運用要件

| 項目 | 内容 |
|------|------|
| バックアップ | `attendances` は日次バックアップ対象 |
| データ保持 | 勤怠データは 5 年間保持（給与計算・税務要件に準拠） |
| 承認権限 | admin は全員の承認が可能。manager は担当 PJ メンバーのみ |

---

## 受け入れ条件（確定）

- [ ] インターンでアクセスすると自分の勤怠一覧が表示される
- [ ] 「OK」ボタンで当月勤怠の `confirm_status` が `'confirmed'` になる
- [ ] 社員・インターンが修正依頼（コメント付き）を送れる
- [ ] 管理者が出退勤時刻を編集して保存できる
- [ ] 管理者が勤怠を承認すると `confirm_status = 'approved'` になりバッジが更新される
- [ ] 承認済みの勤怠を本人が修正しようとすると「承認済みの勤怠は修正できません。管理者にお問い合わせください」が表示される
- [ ] 打刻漏れ日（`clock_in IS NULL`）がオレンジ強調される
- [ ] 管理者に時給単価・給与見込みが表示される
- [ ] `audit_logs` に承認・編集のレコードが追加されている
