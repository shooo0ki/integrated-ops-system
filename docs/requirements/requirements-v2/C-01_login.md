# C-01 ログイン画面 — 要件定義 v2（確定版）

> 作成日: 2026-02-20 | v1 → v2 更新（認証方式変更）

---

## v1 からの変更点

| 区分 | 内容 |
|------|------|
| 認証方式 | **Slack / Google OAuth 2.0 を廃止**し、**メールアドレス + パスワード認証**に変更 |
| データ要件 | `user_accounts` から `oauth_provider` / `oauth_provider_id` を削除。`password_hash`（bcrypt）を追加 |
| 非機能要件 | CSRF 対策を double-submit-cookie 方式に明記。レート制限・ブルートフォース対策を追加 |
| 運用要件 | 初期パスワード設定フローを明記 |

---

## 機能要件（確定）

| 優先度 | 要件 |
|--------|------|
| Must | メールアドレスとパスワードを入力してログインできる |
| Must | 入力した認証情報を `user_accounts` と照合し、不一致の場合はエラーを表示する |
| Must | 認証成功後、ロール情報を含むセッションを生成し、ダッシュボード（C-02）にリダイレクトする |
| Must | セッション有効期限は 24 時間とし、期限切れ時はログイン画面にリダイレクトしてメッセージを表示する |
| Must | ログイン失敗は「メールアドレスまたはパスワードが正しくありません」の**汎用メッセージ**で返す（アカウント存在有無を漏洩しない） |
| Must | 同一 IP から 10 回連続失敗で 15 分間ログインをブロックする（レート制限） |
| Should | ロゴ・システム名・フッター（バージョン情報）を表示する |
| Should | パスワード欄に「表示/非表示」トグルを設ける |
| Could | 「パスワードを忘れた場合」のリセット導線（v1 では管理者に問い合わせ案内のみ） |

---

## データ要件（確定）

| テーブル | カラム | 用途 |
|---------|--------|------|
| `user_accounts` | `email` | ログイン識別子 |
| `user_accounts` | `password_hash` | bcrypt ハッシュと照合 |
| `user_accounts` | `role` | ログイン後の権限制御 |
| `user_accounts` | `member_id` | アカウントに紐づくメンバー情報参照 |

**セッションに含める情報（確定）:**
```json
{
  "user_id": "UUID",
  "member_id": "UUID",
  "role": "admin | manager | employee | intern",
  "email": "string",
  "expires_at": "ISO8601"
}
```

**セッション実装:** `iron-session` または NextAuth.js Credentials Provider を使用。Cookie に `HttpOnly / Secure / SameSite=Lax` を付与。

---

## 非機能要件（確定）

| 区分 | 内容 |
|------|------|
| 性能 | ページ表示 1.5 秒以内（LCP）。ログイン API 応答 1 秒以内 |
| セキュリティ | HTTPS 必須。CSRF 対策（double-submit-cookie）。パスワードは bcrypt（コスト 12）でハッシュ保存。平文は DB・ログに一切記録しない。ブルートフォース対策（10回失敗で 15 分ブロック）|
| 監査 | ログイン成功・失敗（メールアドレス・タイムスタンプ・IPアドレス）をサーバーログに記録。`audit_logs` への記録は不要 |
| ログ | 認証エラーをサーバーログに `WARN` レベルで出力 |
| セッション | 有効期限 24 時間。ブラウザ閉じても継続（Cookie ベース） |
| 可用性 | DB 障害時もエラーメッセージを表示してシステムがクラッシュしないこと |

---

## 運用要件

| 項目 | 内容 |
|------|------|
| バックアップ | `user_accounts` テーブルは日次バックアップ対象 |
| データ保持 | ログイン試行ログは 90 日間保持後に自動削除 |
| 初期パスワード設定 | 管理者がメンバー登録時（M1-03）に初期パスワードを設定する。ユーザーは初回ログイン後にマイページ（C-04）でパスワードを変更することを推奨 |
| パスワードリセット | ユーザーがパスワードを忘れた場合は管理者が新しいパスワードを設定する（C-04 / 管理者向け機能）。メールによる自動リセットは v1 対象外 |
| 権限運用 | `user_accounts` の新規作成・ロール変更は管理者のみ（M1-03 または C-03） |

---

## 受け入れ条件（確定）

- [ ] 正しいメールアドレスとパスワードでログインするとダッシュボード（C-02）にリダイレクトされる
- [ ] 誤ったパスワードを入力すると「メールアドレスまたはパスワードが正しくありません」が表示される
- [ ] 存在しないメールアドレスを入力しても同じ汎用エラーメッセージが表示される（アカウント存在有無を漏洩しない）
- [ ] 同一 IP から 10 回連続失敗すると「ログインを一時的にブロックしました。15分後に再試行してください」が表示される
- [ ] セッション期限切れ状態でページアクセスした場合、ログイン画面にリダイレクトされ「セッションが切れました。再ログインしてください。」が表示される
- [ ] ログイン画面は認証なしでアクセス可能（パブリック）
- [ ] admin ロールでログインすると管理者向けダッシュボードが表示される
- [ ] intern ロールでログインすると打刻画面が表示される

---

## エラー定義（確定）

| エラー条件 | HTTPステータス | 表示内容 | ログ |
|-----------|--------------|---------|------|
| メール/パスワード不一致 | 200（ログイン画面のまま） | 「メールアドレスまたはパスワードが正しくありません」 | WARN |
| レート制限超過 | 200（ログイン画面） | 「ログインを一時的にブロックしました。15分後に再試行してください」 | WARN |
| セッション期限切れ | 302 → ログイン画面 | 「セッションが切れました。再ログインしてください。」 | INFO |
| DB エラー | 500 | 「ログインに失敗しました。再度お試しください。」 | ERROR |
