# M4-02 勤務予定登録 — 要件定義 v2（確定版）

> 作成日: 2026-02-20 | v1 → v2 更新

---

## v1 からの変更点

| 区分 | 内容 |
|------|------|
| データ要件 | カラム名を `is_off`（v1: `is_day_off`）に統一。UPSERT 仕様を明記 |
| 非機能要件 | 確定値に更新 |
| 運用要用 | セクション新設 |

---

## 機能要件（確定）

| 優先度 | 要件 |
|--------|------|
| Must | 翌週の勤務予定（曜日ごとの開始・終了時刻）を登録・更新できる |
| Must | 出勤する曜日は開始時刻を必須とし、終了時刻は開始時刻より後であることをバリデーションする |
| Must | 「終日休み」チェックボックスで曜日単位の休みを設定できる（`is_off = true`） |
| Must | 本人は前日までの予定を変更できる（当日以降は変更不可） |
| Must | 管理者は全メンバーの予定を登録・変更できる（当日以降も可） |
| Must | 前週からコピーボタンで前週の設定を翌週に複製できる |
| Must | 保存ボタンで予定を登録（同週の既存データは UPSERT で上書き） |
| Should | 対象週（翌週の日付）を画面に明示する |

---

## データ要件（確定）

| テーブル | カラム | 制約 |
|---------|--------|------|
| `work_schedules` | `member_id`, `date`, `start_time`, `end_time`, `is_off` | UNIQUE(member_id, date) |

**UPSERT 仕様（確定）:**
```sql
INSERT INTO work_schedules (member_id, date, start_time, end_time, is_off)
VALUES (:memberId, :date, :startTime, :endTime, :isOff)
ON CONFLICT (member_id, date) DO UPDATE
  SET start_time = EXCLUDED.start_time,
      end_time = EXCLUDED.end_time,
      is_off = EXCLUDED.is_off,
      updated_at = NOW();
```

`is_off = true` の場合、`start_time` / `end_time` は NULL で保存する。

---

## 非機能要件（確定）

| 区分 | 内容 |
|------|------|
| 性能 | 保存 API 応答 200ms 以内（7レコードの UPSERT） |
| セキュリティ | 認証必須。本人以外のデータ変更はサーバー側で検証（管理者は例外） |
| 監査 | 予定の変更を `audit_logs` に記録（対象メンバー・対象日・変更前後の時刻） |
| ログ | バリデーションエラー・DB エラーをサーバーログに記録 |
| 可用性 | 前週コピーが失敗してもエラーメッセージを表示し、手動入力が可能なこと |

---

## 運用要件

| 項目 | 内容 |
|------|------|
| バックアップ | `work_schedules` は日次バックアップ対象 |
| データ保持 | 勤務予定は 3 年間保持後にアーカイブ |

---

## 受け入れ条件（確定）

- [ ] 月曜〜日曜の開始・終了時刻を入力して保存すると予定が登録される
- [ ] 終了時刻が開始時刻と同じ or 前の場合「終了時刻は開始時刻より後に設定してください」が表示される
- [ ] 本人が当日以降の予定を変更しようとすると「当日以降の予定変更は管理者のみ行えます」が表示される
- [ ] 管理者は当日以降の予定も変更できる
- [ ] 「前週からコピー」で前週の設定が翌週の入力フォームにコピーされる
- [ ] 「終日休み」チェックで対象曜日の時刻入力が無効化され、`is_off = true` で保存される
- [ ] 保存後、同週の既存データが UPSERT で上書きされる
