# M4-03 打刻画面 — 要件定義 v2（確定版）

> 作成日: 2026-02-20 | v1 → v2 更新

---

## v1 からの変更点

| 区分 | 内容 |
|------|------|
| データ要件 | テーブル名を物理名に統一。`work_minutes` 自動計算式を確定 |
| 非機能要件 | Slack 通知の非同期処理をキュー（bg job）と明記。打刻の応答は 500ms 以内に強化 |
| 運用要件 | セクション新設 |

---

## 機能要件（確定）

| 優先度 | 要件 |
|--------|------|
| Must | 「今日やること」入力後に「出勤する」ボタンを押すと現在時刻で出勤記録を作成する |
| Must | 出勤記録作成と同時に Slack 通知を非同期送信する（Slack 失敗でも打刻は記録する） |
| Must | 出勤後に「退勤する」ボタンを押すと現在時刻で退勤記録を作成し、`work_minutes` を算出する |
| Must | 退勤時に「休憩時間（分）」「今日やったこと」「明日やること」の入力を必須とする |
| Must | 退勤記録作成と同時に Slack 通知を非同期送信する |
| Must | 二重出勤（当日すでに `clock_in` が存在）を拒否する |
| Must | 「今日やること」未入力で出勤ボタン押下はバリデーションエラーを表示する |
| Must | 全ロールが自分の打刻のみ操作できる |
| Must | 退勤後は当日の勤務サマリー（出勤・退勤・実働時間）を表示する |
| Should | 状態に応じて UI を切り替える（未打刻 / 出勤後退勤前 / 退勤後） |

---

## データ要件（確定）

| テーブル | カラム | 制約 |
|---------|--------|------|
| `attendances` | `id`, `member_id`, `date`, `clock_in`, `clock_out`, `break_minutes`, `work_minutes`, `todo_today`, `done_today`, `todo_tomorrow`, `status`, `slack_notified` | UNIQUE(member_id, date) |

**work_minutes 計算式（確定）:**
```
work_minutes = EXTRACT(EPOCH FROM (clock_out - clock_in)) / 60 - break_minutes
```

**Slack 通知テンプレート（確定）:**
- 出勤時: `[氏名] が出勤しました（HH:MM）\n本日のタスク: [todo_today]`
- 退勤時: `[氏名] が退勤しました（HH:MM）\n勤務時間: X時間Y分\n実績: [done_today]\n明日の予定: [todo_tomorrow]`

**slack_notified フラグ:** Slack 送信成功後に `true` に更新。失敗時は `false` のまま（再送候補として管理）

---

## 非機能要件（確定）

| 区分 | 内容 |
|------|------|
| 性能 | 打刻ボタン押下から DB 記録完了まで 500ms 以内。Slack 通知は非同期（バックグラウンドジョブ）で処理しレスポンスをブロックしない |
| セキュリティ | 認証必須。他メンバーの打刻は操作不可（サーバー側で `member_id = session.member_id` を検証） |
| 監査 | 出退勤記録の作成を `audit_logs` に記録（action = 'CREATE'） |
| ログ | Slack 通知失敗のエラー詳細をサーバーログに `ERROR` レベルで記録 |
| 可用性 | Slack 通知失敗は打刻の正常完了に影響しない |

---

## 運用要件

| 項目 | 内容 |
|------|------|
| バックアップ | `attendances` は日次バックアップ対象 |
| データ保持 | 勤怠データは 5 年間保持（給与・税務の法定保存期間に準拠） |
| Slack 再通知 | `slack_notified = false` のレコードを対象に定期バッチ（1 時間おき）で再通知を試みる運用を推奨 |

---

## 受け入れ条件（確定）

- [ ] 「今日やること」を入力して「出勤する」を押すと `attendances` に `clock_in` が記録される
- [ ] 「今日やること」未入力で出勤ボタンを押すと「今日やることを入力してください」が表示される
- [ ] 出勤後に退勤画面（出勤時刻・退勤ボタン・各入力欄）に切り替わる
- [ ] 退勤時に必須項目が未入力だと各項目に「入力してください」が表示される
- [ ] 退勤ボタン押下後、`work_minutes` が正しく計算され勤務サマリーが表示される
- [ ] Slack 通知失敗時「Slack 通知に失敗しましたが、打刻は記録されました」トーストが表示される
- [ ] 二重出勤で「本日はすでに出勤済みです」が表示される
- [ ] `audit_logs` に出退勤レコードが追加されている
