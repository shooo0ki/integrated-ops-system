# M2-03 スキル評価入力 — 要件定義 v2（確定版）

> 作成日: 2026-02-20 | v1 → v2 更新

---

## v1 からの変更点

| 区分 | 内容 |
|------|------|
| データ要件 | テーブル名を物理名に統一。`evaluated_by` カラムの記録を明記 |
| 非機能要件 | 監査ログ先を `audit_logs` テーブルに明記 |
| 運用要件 | セクション新設 |

---

## 機能要件（確定）

| 優先度 | 要件 |
|--------|------|
| Must | 対象メンバーのスキルカテゴリ別にスキルレベル（1〜5）を入力・更新できる |
| Must | 評価日（過去日または当日）と評価メモ（任意）を登録できる |
| Must | 評価は `member_skills` に追記（履歴保持・上書きなし） |
| Must | 現在のレベル（最新評価値）とレベルラベルを表示する |
| Must | 評価履歴（評価日・レベル・メモの時系列）を表示する |
| Must | 管理者は全メンバーを評価できる |
| Must | マネージャーは担当 PJ メンバーのみ評価できる |
| Must | 社員・インターンは自分のスキルを閲覧のみ（評価不可） |
| Must | レベル未選択で保存しようとするとバリデーションエラー |
| Should | スキルカテゴリをタブで切り替えて表示する |
| Should | 評価履歴はアコーディオンで折りたたみ表示する |

---

## データ要件（確定）

| テーブル | カラム | 制約 |
|---------|--------|------|
| `member_skills` | `id`, `member_id`, `skill_id`, `level`, `evaluated_at`, `memo`, `evaluated_by` | 評価ごとに INSERT（UPDATE しない） |
| `skills` | `id`, `name`, `category_id` | スキル情報表示用 |
| `skill_categories` | `id`, `name`, `display_order` | タブ表示用 |
| `members` | `id`, `name` | ヘッダー表示用 |

**INSERT 仕様:**
```sql
INSERT INTO member_skills (member_id, skill_id, level, evaluated_at, memo, evaluated_by)
VALUES (:memberId, :skillId, :level, :evaluatedAt, :memo, :currentUserId);
```

**レベルラベル定義（確定）:**

| level | ラベル |
|-------|--------|
| 1 | 初学者 |
| 2 | 初級 |
| 3 | 中級 |
| 4 | 上級 |
| 5 | エキスパート |

---

## 非機能要件（確定）

| 区分 | 内容 |
|------|------|
| 性能 | 評価保存 API 応答 200ms 以内 |
| セキュリティ | 権限チェックはサーバー側で実施（マネージャーの担当外アクセスを拒否） |
| 監査 | 評価追加を `audit_logs` に記録（`action = 'CREATE'`、`target_table = 'member_skills'`、before_data = 直前の評価値） |
| ログ | 権限エラー・DB エラーをサーバーログに記録 |
| 可用性 | 保存失敗時はリトライが可能なこと |

---

## 運用要件

| 項目 | 内容 |
|------|------|
| バックアップ | `member_skills` は日次バックアップ対象 |
| データ保持 | 評価履歴は永久保持。削除は管理者による DB 直接操作のみ |
| 権限運用 | 評価権限は admin / manager。manager は担当 PJ メンバーのみ |

---

## 受け入れ条件（確定）

- [ ] 管理者がスキルレベル 3・評価日・メモを入力して保存すると `member_skills` にレコードが追加される
- [ ] 保存後、最新レベルが更新された値で表示される
- [ ] 評価履歴に新しい評価が追加される（古い評価レコードは残る）
- [ ] レベル未選択で保存ボタンを押すと「レベルを選択してください」が表示される
- [ ] 評価日に未来の日付を入力するとバリデーションエラーが表示される
- [ ] マネージャーが担当外メンバーの評価画面にアクセスすると 403 が返る
- [ ] 社員でアクセスすると入力フォームが非表示（閲覧のみ）
- [ ] `audit_logs` に評価追加のレコードが記録されている
