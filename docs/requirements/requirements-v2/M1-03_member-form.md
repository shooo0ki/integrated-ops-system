# M1-03 メンバー登録 / 編集 — 要件定義 v2（確定版）

> 作成日: 2026-02-20 | v1 → v2 更新

---

## v1 からの変更点

| 区分 | 内容 |
|------|------|
| データ要件 | テーブル名・カラム名を物理名に統一。`user_accounts` 作成フロー（新規登録時）を追記 |
| 非機能要件 | 画像アップロード先をストレージ（S3互換）として明記 |
| 運用要件 | セクション新設 |
| 受け入れ条件 | 監査ログへの記録確認を追加 |

---

## 機能要件（確定）

| 優先度 | 要件 |
|--------|------|
| Must | 管理者は新規メンバーを全項目入力して登録できる |
| Must | 管理者は既存メンバーの全項目を編集できる |
| Must | 社員・インターン（本人）は氏名・電話番号・住所・銀行口座情報のみ編集できる |
| Must | マネージャーはメンバー登録・編集を行えない（403） |
| Must | 時給制メンバーの場合、住所・銀行口座情報（銀行名・支店名・口座番号・口座名義）を必須とする |
| Must | メールアドレスはシステム内で一意であることをバリデーションする（`user_accounts.email` のUNIQUE制約） |
| Must | 退社日は入社日以降であることをバリデーションする |
| Must | プロフィール画像アップロードは JPEG/PNG・5MB 以内を許容する |
| Must | 保存成功後、M1-02 メンバー詳細または M1-01 一覧に遷移する |
| Must | 新規登録時に `user_accounts` も同時に作成する（メールアドレス・ロール・初期パスワードを設定） |
| Must | 初期パスワードは管理者が入力する（8 文字以上・英数字混在を必須とする） |
| Must | 稼働配分の固定値は入力しない（稼働実績は勤怠打刻時のPJ配分から集計する） |
| Must | 利用ツールは管理者が追加/編集/削除できる（本人フォームではツール編集不可、契約書用DocuSign送信とは別セクションで管理） |
| Must | ツール登録時は「ツール名 / プラン」をプルダウン（例: Slack Free/Pro/Business, Claude Pro/Team/Max 等）で選択できる。プラン変更のみの場合も選択だけで済む |
| Must | ツールの請求先会社ラベルは初期値を所属会社に自動設定し、必要に応じてBoost/SALT2に変更できる |
| Must | ツール月額は数値入力フィールドで記入する（通貨はシステム共通設定に従う） |
| Must | 既存ツールのプラン変更は「その行を編集してプランを選び直す」だけで完了する（削除→再追加を強制しないが、削除/追加も可能） |
| Must | 契約書テンプレートが既に `completed` の場合、送信ボタンを無効化し「契約書締結済み」を表示する |
| Should | 編集時にキャンセルボタンで変更を破棄して前の画面に戻る |
| Could | 画像プレビューをアップロード前に表示する |

---

## データ要件（確定）

### members テーブル（書き込み対象）

| フィールド | 物理名 | 型 | 必須 | 制約 |
|-----------|--------|-----|------|------|
| 氏名 | `name` | VARCHAR(100) | ○ | 最大 100 文字 |
| プロフィール画像 | `profile_image_url` | TEXT | — | ストレージ URL |
| 電話番号 | `phone` | VARCHAR(20) | — | 数字・ハイフン |
| 住所 | `address` | TEXT | △ | 時給制メンバーは必須 |
| ステータス | `status` | ENUM | ○ | `executive`/`employee`/`intern_full`/`intern_training`/`training_member` |
| 所属会社 | `company` | ENUM | ○ | `boost` / `salt2` |
| 報酬形態 | `salary_type` | ENUM | ○ | `hourly` / `monthly` |
| 報酬金額 | `salary_amount` | INTEGER | ○ | 正の整数 |
| 銀行名 | `bank_name` | TEXT | △ | 時給制は必須・AES-256 暗号化 |
| 支店名 | `bank_branch` | TEXT | △ | 時給制は必須・AES-256 暗号化 |
| 口座番号 | `bank_account_number` | TEXT | △ | 時給制は必須・数字 7 桁・AES-256 暗号化 |
| 口座名義 | `bank_account_holder` | TEXT | △ | 時給制は必須・AES-256 暗号化 |
| 入社日 | `joined_at` | DATE | ○ | YYYY-MM-DD |
| 退社日 | `left_at` | DATE | — | joined_at 以降 |

### user_accounts テーブル（新規登録時のみ同時作成）

| フィールド | 物理名 | 備考 |
|-----------|--------|------|
| メールアドレス | `email` | 入力値をそのまま使用 |
| パスワードハッシュ | `password_hash` | 管理者が入力した初期パスワードを bcrypt（コスト 12）でハッシュ化して保存 |
| ロール | `role` | フォームで選択 |
| member_id | `member_id` | 作成した members.id を設定 |

---

## 非機能要件（確定）

| 区分 | 内容 |
|------|------|
| 性能 | 保存 API 応答 300ms 以内（画像アップロードは除く）。画像アップロードは非同期処理（S3 互換ストレージへ直接 PUT） |
| セキュリティ | 銀行口座情報は AES-256 暗号化してから DB 保存。フォームの権限制御はサーバー側でも検証 |
| 監査 | 登録・編集操作を `audit_logs` に記録（`action = 'CREATE'` または `'UPDATE'`、変更前後の値） |
| ログ | バリデーションエラー・保存失敗をサーバーログに記録 |
| 可用性 | 画像アップロード失敗でも、画像なしでメンバー情報は保存できること |

---

## 運用要件

| 項目 | 内容 |
|------|------|
| バックアップ | `members` / `user_accounts` は日次バックアップ対象 |
| 画像保管 | プロフィール画像は S3 互換ストレージに保存。URL は `members.profile_image_url` に保持 |
| 暗号化鍵管理 | 銀行口座の AES-256 鍵は環境変数 `MEMBER_ENCRYPTION_KEY` で管理 |
| 退社処理 | `left_at` を設定することで論理削除。`user_accounts` の無効化は `role` を変更するか別途フラグで管理 |

---

## 受け入れ条件（確定）

- [ ] 管理者が全必須項目を入力して保存すると新規メンバーが作成される
- [ ] 新規登録時に `user_accounts` レコードも同時に作成される
- [ ] 重複するメールアドレスで保存すると「このメールアドレスはすでに登録されています」が表示される
- [ ] 時給制を選択して住所を空のまま保存すると「時給制メンバーは住所を入力してください」が表示される
- [ ] 退社日に入社日より前の日付を入力すると「退社日は入社日以降に設定してください」が表示される
- [ ] 5MB 超の画像をアップロードするとエラーが表示される
- [ ] 社員（本人）が氏名・電話・住所・銀行口座のみ編集して保存できる
- [ ] 社員（本人）がロール・報酬情報を変更しようとしても対象フィールドは表示されない
- [ ] マネージャーでフォームにアクセスすると 403 が返る
- [ ] 保存後に `audit_logs` にレコードが追加されている
