# M3-05 工数管理 — 要件定義 v2（確定版）

> 作成日: 2026-02-20 | v1 → v2 更新

---

## v1 からの変更点

| 区分 | 内容 |
|------|------|
| データ要件 | テーブル名を物理名に統一。マトリクス表示対象の抽出条件 SQL を確定 |
| 非機能要件 | 確定値に更新 |
| 運用要件 | セクション新設 |

---

## 機能要件（確定）

| 優先度 | 要件 |
|--------|------|
| Must | 対象月を選択し、メンバー × PJ マトリクス（行: メンバー / 列: PJ / セル: 工数時間）を表示する |
| Must | 編集モードでセルを直接編集し、月間工数を変更できる |
| Must | 変更を一括保存できる |
| Must | 工数が負の値の場合はバリデーションエラーを表示する |
| Must | 行合計・列合計を自動表示する |
| Must | 管理者は全 PJ・全メンバーを閲覧・編集できる |
| Must | マネージャーは担当 PJ のみ閲覧・編集できる |
| Must | 社員・インターンはアクセス不可（403） |
| Should | 前月・翌月ナビゲーションで月を切り替えられる |

---

## データ要件（確定）

| テーブル | カラム | 備考 |
|---------|--------|------|
| `project_assignments` | `member_id`, `project_id`, `workload_hours`, `start_date`, `end_date` | マトリクスデータソース |
| `projects` | `id`, `name`, `deleted_at` | 列ヘッダー |
| `members` | `id`, `name`, `deleted_at` | 行ヘッダー |

**マトリクス表示対象の抽出条件（確定）:**
```sql
SELECT pa.*, p.name as project_name, m.name as member_name
FROM project_assignments pa
JOIN projects p ON p.id = pa.project_id
JOIN members m ON m.id = pa.member_id
WHERE p.deleted_at IS NULL
  AND m.deleted_at IS NULL
  AND pa.start_date <= :monthEnd      -- 月末以前に開始
  AND (pa.end_date IS NULL OR pa.end_date >= :monthStart)  -- 月初以降まで継続
```

---

## 非機能要件（確定）

| 区分 | 内容 |
|------|------|
| 性能 | マトリクス表示 2 秒以内 |
| セキュリティ | 認証必須。マネージャーの担当外データはサーバー側で除外 |
| 監査 | 工数変更を `audit_logs` に記録（action = 'UPDATE'、メンバー・PJ・変更前後の工数） |
| ログ | 保存エラーをサーバーログに記録 |
| 可用性 | 一括保存は失敗した行のみエラーを返し、成功した行は保存されること（部分コミット可） |

---

## 運用要件

| 項目 | 内容 |
|------|------|
| バックアップ | `project_assignments` は日次バックアップ対象 |
| データ保持 | 工数変更履歴は `audit_logs` で管理 |

---

## 受け入れ条件（確定）

- [ ] 管理者でアクセスすると当月の全メンバー × 全 PJ マトリクスが表示される
- [ ] 工数セルを編集して保存すると値が更新される
- [ ] 工数に負の値を入力すると「0 以上の値を入力してください」が表示される
- [ ] 行合計・列合計が自動計算される
- [ ] 前月・翌月ナビで月を切り替えると対応データが読み込まれる
- [ ] マネージャーが担当外 PJ の列を表示できない（担当 PJ のみ表示）
- [ ] 社員でアクセスすると 403 が返る
- [ ] `audit_logs` に工数変更のレコードが追加されている
