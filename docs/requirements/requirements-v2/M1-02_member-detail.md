# M1-02 メンバー詳細 — 要件定義 v2（確定版）

> 作成日: 2026-02-20 | v1 → v2 更新

---

## v1 からの変更点

| 区分 | 内容 |
|------|------|
| データ要件 | テーブル名・カラム名を物理名に統一。`member_tools` / `member_contracts` を表示対象に追加 |
| アクセス制御 | ページ閲覧は全ロールに許可しつつ、表示項目をロールで分岐：管理者/本人=全項目、その他ロール=週間スケジュール・配属PJ・スキルのみ（報酬/銀行/ツール/契約書は非表示） |
| ページレイアウト | 週間スケジュールセクションをページ最上部に表示する要件を追加 |
| 非機能要件 | 銀行口座参照の監査ログを `audit_logs` への記録として明記 |
| 運用要件 | セクション新設 |

---

## 機能要件（確定）

| 優先度 | 要件 |
|--------|------|
| Must | ページ最上部に対象メンバーの**週間スケジュール**（当週の勤務予定）を表示する |
| Must | 指定メンバーのプロフィール情報を表示する（表示範囲はロールで分岐） |
| Must | 報酬情報（報酬形態・金額）は管理者のみ表示する |
| Must | 銀行口座情報は管理者と本人のみ表示する（DB上では AES-256 暗号化済み） |
| Must | アサイン中プロジェクト一覧を**全ロール**が閲覧できる |
| Must | スキル評価サマリー（カテゴリ別の最新レベル）を**全ロール**が閲覧できる |
| Must | 利用ツール一覧（`member_tools`）を表示する（管理者・本人のみ） |
| Must | 利用ツールは管理者が編集できる（追加/更新/削除）、本人は閲覧のみ |
| Must | 契約書一覧（`member_contracts`）を表示する（管理者・本人のみ） |
| Must | 契約書ステータスが `completed`（締結） の場合、送信系ボタンは表示しない／無効化し、「契約書締結済み」ラベルのみ表示する |
| Must | 管理者は全メンバーの詳細にアクセスできる（全項目表示） |
| Must | 本人は自分の詳細を全項目表示で閲覧できる |
| Must | マネージャー・社員・インターンは他メンバー詳細で「週間スケジュール・配属PJ・スキルサマリー・基本情報（氏名/会社/ロール）」のみ閲覧可能（報酬/銀行/ツール/契約書は非表示） |
| Must | 存在しない ID へのアクセスは 404 を返す |
| Should | 編集ボタンを表示し、M1-03 編集フォームに遷移する（管理者のみ） |

---

## データ要件（確定）

| テーブル | カラム | 表示条件 |
|---------|--------|---------|
| `work_schedules` | `date`, `start_time`, `end_time`, `is_off` | **全ロール**（当週 7 日分） |
| `members` | `id`, `name`, `profile_image_url`, `phone`, `address`, `status`, `company`, `joined_at`, `left_at` | 管理者/本人は全項目、その他ロールは `id`,`name`,`company`,`role`,`status` のみ |
| `members` | `salary_type`, `salary_amount` | 管理者のみ |
| `members` | `bank_name`, `bank_branch`, `bank_account_number`, `bank_account_holder` | 管理者 + 本人のみ（復号して表示） |
| `user_accounts` | `email`, `role` | 管理者のみ |
| `project_assignments` | `project_id`, `position_id`, `workload_hours`, `start_date`, `end_date` | **全ロール** |
| `projects` | `name`, `status`, `company` | **全ロール**（アサイン一覧のラベル用） |
| `member_skills` | `skill_id`, `level`, `evaluated_at` | **全ロール**（最新評価のみ表示） |
| `member_tools` | `tool_name`, `plan`, `monthly_cost`, `company_label` | 管理者 + 本人のみ |
| `member_contracts` | `status`, `template_name`, `start_date`, `completed_at` | 管理者 + 本人のみ |

**スキルサマリーのクエリ（最新評価取得）:**
```sql
SELECT DISTINCT ON (member_id, skill_id)
  member_id, skill_id, level, evaluated_at
FROM member_skills
WHERE member_id = :memberId
ORDER BY member_id, skill_id, evaluated_at DESC
```

---

## 非機能要件（確定）

| 区分 | 内容 |
|------|------|
| 性能 | ページ表示 2 秒以内 |
| セキュリティ | 銀行口座情報は DB 上で AES-256 暗号化保存。API レスポンスでも権限なしロールには返さない。アクセス制御はサーバー側で必ず検証 |
| 監査 | 詳細閲覧ログ（閲覧者 ID・対象メンバー ID・タイムスタンプ）をサーバーログに記録。銀行口座参照時は `audit_logs` にも `action = 'READ_SENSITIVE'` として記録 |
| ログ | 403 / 404 発生をサーバーログに `WARN` レベルで記録 |
| 可用性 | 部分的なデータ取得失敗でもプロフィール基本情報は表示できること |

---

## 運用要件

| 項目 | 内容 |
|------|------|
| バックアップ | `members` / `member_tools` / `member_contracts` は日次バックアップ対象 |
| データ保持 | 退社メンバーは `left_at` を設定し論理削除で保持。給与・請求書算出の参照を維持する |
| 権限運用 | 銀行口座情報の参照ログは四半期ごとに管理者が確認する運用を推奨 |
| 暗号化鍵管理 | AES-256 鍵は環境変数 `MEMBER_ENCRYPTION_KEY` で管理。コードに埋め込まない |

---

## ページレイアウト（確定）

```
┌────────────────────────────────┐
│ 週間スケジュール（最上部）        │  ← work_schedules（全ロール閲覧可）
├────────────────────────────────┤
│ プロフィール基本情報              │  ← members
├────────────────────────────────┤
│ 配属プロジェクト一覧              │  ← project_assignments（全ロール閲覧可）
├────────────────────────────────┤
│ スキルサマリー                    │  ← member_skills（全ロール閲覧可）
├────────────────────────────────┤
│ 利用ツール（管理者・本人のみ）     │  ← member_tools
├────────────────────────────────┤
│ 契約書一覧（管理者・本人のみ）     │  ← member_contracts
└────────────────────────────────┘
```

---

## 受け入れ条件（確定）

- [ ] ページ最上部に当週の勤務予定スケジュールが表示される
- [ ] 管理者でアクセスすると全項目（報酬・銀行口座・ツール・契約書含む）が表示される
- [ ] 本人でアクセスすると全項目（報酬・銀行口座・ツール・契約書含む）が表示される
- [ ] マネージャーで他メンバー詳細にアクセスすると報酬・銀行口座・ツール・契約書が非表示になり、週スケ・配属PJ・スキル・基本情報のみ表示される
- [ ] 社員・インターンで他メンバー詳細にアクセスすると報酬・銀行口座・ツール・契約書が非表示になり、週スケ・配属PJ・スキル・基本情報のみ表示される
- [ ] 社員・インターンが自分の詳細を開くと銀行口座・ツール・契約書が表示される
- [ ] 存在しない ID にアクセスすると 404 が返る
- [ ] 管理者に「編集」ボタンが表示され、クリックで M1-03 に遷移する
- [ ] スキルサマリーが各スキルの最新評価レベルで表示される
- [ ] 利用ツール一覧が管理者・本人のみ表示される
- [ ] 契約書一覧が管理者・本人のみ表示される
