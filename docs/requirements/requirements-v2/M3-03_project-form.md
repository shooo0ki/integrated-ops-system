# M3-03 プロジェクト登録 / 編集 — 要件定義 v2（確定版）

> 作成日: 2026-02-20 | v1 → v2 更新

---

## v1 からの変更点

| 区分 | 内容 |
|------|------|
| データ要件 | テーブル名・カラム名を物理名に統一 |
| 非機能要件 | 監査ログ先（`audit_logs`）を明記 |
| 運用要件 | セクション新設 |

---

## 機能要件（確定）

| 優先度 | 要件 |
|--------|------|
| Must | 新規プロジェクトを基本情報で登録できる（名称・ステータス・所属会社・開始日・終了日・クライアント名・契約形態・月額）|
| Must | 既存プロジェクトを編集できる |
| Must | ポジションを複数定義できる（名称・必要人数・必要スキル） |
| Must | 初期ポジション一覧（PM / 担当リーダー / メインエンジニア / ジュニアエンジニア / メインDS / ジュニアDS / メイン営業 / 営業アシスタント）を選択肢として提示し、管理者が追加・編集できる |
| Must | 終了日が開始日より前の場合はバリデーションエラーを表示する |
| Must | アサインがあるポジションは削除できない（`project_assignments` 参照チェック） |
| Must | 管理者は全 PJ の作成・編集ができる |
| Must | マネージャーは担当 PJ のみ編集できる（新規作成も可） |
| Must | 社員・インターンはアクセス不可（403） |
| Should | ポジション定義でドロップダウンから既存ポジション名を選択、または新規入力できる |
| Should | 必要スキルとして「スキル + 最低レベル」を複数設定できる |

---

## データ要件（確定）

### projects テーブル（書き込み対象）

| フィールド | 物理名 | 型 | 必須 | 制約 |
|-----------|--------|-----|------|------|
| PJ名 | `name` | VARCHAR(200) | ○ | 最大 200 文字 |
| 説明 | `description` | TEXT | — | 最大 1000 文字 |
| ステータス | `status` | ENUM | ○ | `planning`/`active`/`completed`/`on_hold` |
| 所属会社 | `company` | ENUM | ○ | `boost` / `salt2` |
| 開始日 | `start_date` | DATE | ○ | YYYY-MM-DD |
| 終了日 | `end_date` | DATE | — | start_date 以降 |
| クライアント名 | `client_name` | VARCHAR(200) | — | 最大 200 文字 |
| 契約形態 | `contract_type` | ENUM | — | `quasi_mandate`/`contract`/`in_house`/`other` |
| 月額契約金額 | `monthly_contract_amount` | INTEGER | — | 0 以上 |
| 作成者 | `created_by` | UUID | ○ | セッションの user_id |

### project_positions テーブル（繰り返し）

| フィールド | 物理名 | 型 | 必須 | 制約 |
|-----------|--------|-----|------|------|
| ポジション名 | `position_name` | VARCHAR(100) | ○ | — |
| 必要人数 | `required_count` | SMALLINT | ○ | 1 以上 |
| 備考 | `description` | TEXT | — | 初期ポジション一覧の説明や責任範囲を格納可 |

### position_required_skills テーブル（ポジション紐づき）

| フィールド | 物理名 | 型 | 必須 | 制約 |
|-----------|--------|-----|------|------|
| スキル ID | `skill_id` | UUID | ○ | FK → skills |
| 最低レベル | `min_level` | SMALLINT | ○ | 1〜5 |

---

## 非機能要件（確定）

| 区分 | 内容 |
|------|------|
| 性能 | 保存 API 応答 300ms 以内 |
| セキュリティ | 認証必須。マネージャーの担当外 PJ 編集はサーバー側で拒否 |
| 監査 | PJ 作成・編集を `audit_logs` に記録（action = 'CREATE' または 'UPDATE'、変更前後の主要項目） |
| ログ | バリデーションエラー・DB エラーをサーバーログに記録 |
| 可用性 | トランザクション: projects / project_positions / position_required_skills を 1 トランザクションで保存 |

---

## 運用要件

| 項目 | 内容 |
|------|------|
| バックアップ | `projects` / `project_positions` / `position_required_skills` は日次バックアップ対象 |
| データ保持 | PJ 削除は `deleted_at` 設定（論理削除）。物理削除は行わない |

---

## 受け入れ条件（確定）

- [ ] 管理者が全必須項目を入力して保存すると新規 PJ が作成される
- [ ] 終了日に開始日より前の日付を入力すると「終了日は開始日以降に設定してください」が表示される
- [ ] アサインがあるポジションを削除しようとすると「アサイン済みのポジションは削除できません」が表示される
- [ ] アサインがないポジションは削除できる
- [ ] マネージャーが担当外 PJ の編集画面にアクセスすると 403 が返る
- [ ] 社員でアクセスすると 403 が返る
- [ ] ポジションを複数追加できる
- [ ] 保存後、M3-02 プロジェクト詳細に遷移する
- [ ] 保存後に `audit_logs` にレコードが追加されている
