# M4-01 全体カレンダー — 要件定義 v2（確定版）

> 作成日: 2026-02-20 | v1 → v2 更新

---

## v1 からの変更点

| 区分 | 内容 |
|------|------|
| データ要件 | テーブル名を物理名に統一。`is_off`（v1: `is_day_off`）に統一 |
| 非機能要件 | 仮想スクロール方針を追記 |
| 運用要件 | セクション新設 |

---

## 機能要件（確定）

| 優先度 | 要件 |
|--------|------|
| Must | 全メンバーの勤務予定（薄色）と出勤実績（濃色）をカレンダー形式で表示する |
| Must | 週間 / 日別 / 月別で表示期間を切り替えられる |
| Must | PJ / 所属会社 / メンバーでフィルタリングができる |
| Must | 勤務予定あり・当日以前・実績未打刻の日をオレンジ強調する（打刻漏れ候補） |
| Must | 管理者は全員を閲覧できる |
| Must | マネージャーは担当 PJ メンバー + 自分を閲覧できる |
| Must | 社員は全員を閲覧できる（勤務時刻の基本情報のみ） |
| Must | インターンは担当 PJ メンバー + 自分を閲覧できる |
| Should | メンバー名クリックで M1-02 メンバー詳細に遷移する |
| Should | セルクリックで当日の勤怠詳細をモーダルで表示する |

---

## データ要件（確定）

| テーブル | カラム | 備考 |
|---------|--------|------|
| `work_schedules` | `member_id`, `date`, `start_time`, `end_time`, `is_off` | 勤務予定（`is_off = false` の場合のみ表示）|
| `attendances` | `member_id`, `date`, `clock_in`, `clock_out` | 出勤実績 |
| `members` | `id`, `name`, `deleted_at` | 行ヘッダー |
| `project_assignments` | `member_id`, `project_id`, `end_date` | マネージャー・インターンのフィルタ用 |

**打刻漏れ候補の条件（確定）:**
```sql
-- work_schedules に当日の is_off = false のレコードがあり
-- かつ attendances に clock_in がない
WHERE ws.date < CURRENT_DATE
  AND ws.is_off = false
  AND (a.id IS NULL OR a.clock_in IS NULL)
```

---

## 非機能要件（確定）

| 区分 | 内容 |
|------|------|
| 性能 | カレンダー表示 2 秒以内。週間表示で最大 100 名 × 7 日 = 700 セルを想定。仮想スクロールでDOM数を制限する |
| セキュリティ | 認証必須。マネージャー・インターンの閲覧範囲制限はサーバー側で適用 |
| 監査 | 閲覧ログ（ユーザー ID・タイムスタンプ）をサーバーログに記録 |
| ログ | API エラーをサーバーログに記録 |
| 可用性 | データ取得失敗時にリトライボタンを表示 |

---

## 運用要件

| 項目 | 内容 |
|------|------|
| バックアップ | `work_schedules` / `attendances` は日次バックアップ対象 |
| データ保持 | 勤務予定・出勤実績は 3 年間保持後にアーカイブ |

---

## 受け入れ条件（確定）

- [ ] 管理者でアクセスすると全メンバーのカレンダーが表示される
- [ ] マネージャーでアクセスすると担当 PJ メンバー + 自分のカレンダーが表示される
- [ ] 勤務予定あり・打刻なしの過去日がオレンジ強調される
- [ ] 出勤実績は濃い緑で表示される
- [ ] 週間 / 日別 / 月別の切り替えが正常に動作する
- [ ] PJ フィルターで特定 PJ のメンバーのみ表示される
- [ ] データ取得失敗時にエラートーストが表示される
