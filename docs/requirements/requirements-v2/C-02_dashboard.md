# C-02 ダッシュボード — 要件定義 v2（確定版）

> 作成日: 2026-02-20 | v1 → v2 更新

---

## v1 からの変更点

| 区分 | 内容 |
|------|------|
| データ要件 | テーブル名を物理名に統一 |
| 非機能要件 | 並列 API 呼び出しをサーバーコンポーネント `Promise.all` で実装と明記 |
| 運用要件 | セクション新設 |

---

## 機能要件（確定）

| 優先度 | 要件 |
|--------|------|
| Must | ログイン後のトップページとして表示し、ロールに応じたウィジェットを出し分ける |
| Must | 社員・インターン向けに「出勤する」「退勤する」クイックアクションボタンを表示する |
| Must | 管理者・マネージャー向けに未打刻メンバー数を赤バッジで表示する |
| Must | 管理者向けに月末締め状況（確認待ち人数）を表示する |
| Must | マネージャー向けに担当 PJ 一覧（進行中のみ）を表示する |
| Must | 管理者向けに全社 PL 粗利（当月）を表示する |
| Should | 管理者向けに社内精算サマリー（Boost⇔SALT2、当月）を表示する |
| Must | 各モジュール（M1〜M6）へのナビゲーションカードを表示し、ロール権限内のものだけリンク有効にする |
| Must | ウィジェットのデータ取得失敗は独立して処理し、失敗したウィジェットだけにエラー表示する |
| Should | お知らせ・アラートエリアを設け、未打刻アラート・月末締め通知をクリックで該当画面に遷移できる |

---

## ロール別ウィジェット表示マトリクス（確定）

| ウィジェット | admin | manager | employee | intern |
|-----------|:---:|:---:|:---:|:---:|
| 出退勤クイックアクション | — | — | ○ | ○ |
| 未打刻メンバー数 | ○ | ○ | — | — |
| 月末締め状況 | ○ | — | — | — |
| 担当 PJ 一覧 | — | ○ | — | — |
| 全社 PL 粗利（当月） | ○ | — | — | — |
| 社内精算サマリー（当月） | ○ | — | — | — |
| ナビゲーションカード | 全モジュール | M1/M2/M3/M4 | M1/M4/M5 | M4/M5 |

---

## データ要件（確定）

| テーブル | カラム | 用途 |
|---------|--------|------|
| `attendances` | `member_id`, `date`, `clock_in`, `clock_out` | 打刻状態・未打刻メンバー数の算出 |
| `projects` | `status`, `company` | 進行中 PJ 一覧（マネージャー向け）|
| `project_assignments` | `member_id`, `project_id` | 担当 PJ 抽出 |
| `pl_records` | `gross_profit`, `target_month`, `record_type` | 全社粗利ウィジェット（管理者）|
| `invoices` | `slack_sent_status`, `target_month` | 月末締め確認待ち人数 |

**未打刻メンバー数の算出条件:**
- 当日に `work_schedules.is_off = false` の予定があるメンバー
- かつ `attendances` に当日レコード（`clock_in IS NOT NULL`）がないメンバー数

---

## 非機能要件（確定）

| 区分 | 内容 |
|------|------|
| 性能 | ダッシュボード初期表示 2 秒以内（TTI）。ウィジェットは Server Component で `Promise.all` による並列取得 |
| セキュリティ | 認証必須。未認証アクセスは `/login` にリダイレクト。ロール外ウィジェットはサーバー側でも除外してレスポンスに含めない |
| 監査 | ダッシュボードアクセスログ（ユーザー ID・タイムスタンプ）をサーバーログに記録 |
| ログ | ウィジェット API エラーはサーバーログに `WARN` レベルで記録（エンドポイント・エラーコード） |
| 可用性 | 1 つのウィジェット取得に失敗しても他のウィジェットへ影響しない（独立エラーハンドリング） |

---

## 運用要件

| 項目 | 内容 |
|------|------|
| バックアップ | ダッシュボード専用テーブルなし。参照先テーブルのバックアップ方針に準じる |
| キャッシュ | 未打刻カウント・PL 粗利は最大 60 秒 stale-while-revalidate でキャッシュ可 |
| 権限運用 | ロール変更は `user_accounts.role` の更新で即時反映（セッション再発行まで最大 24 時間遅延） |

---

## 受け入れ条件（確定）

- [ ] 管理者でログインすると全ウィジェットが表示される
- [ ] マネージャーでログインすると「担当 PJ 一覧」「未打刻メンバー数」のみが表示される
- [ ] 社員・インターンでログインすると「本日の打刻状態」クイックアクションと限定モジュールカードが表示される
- [ ] 「出勤する」ボタン押下で M4-03 打刻画面に遷移する
- [ ] 特定ウィジェットのデータ取得が失敗しても、他のウィジェットは正常に表示される
- [ ] 管理者ロールで「全社 PL 粗利（当月）」が正しい数値で表示される
- [ ] 未打刻メンバー数が 0 件の場合、赤バッジは非表示
- [ ] 未認証でアクセスすると `/login` にリダイレクトされる

---

## エラー定義（確定）

| エラー条件 | 表示内容 | 対処 |
|-----------|---------|------|
| ウィジェットデータ取得失敗 | 「データを取得できませんでした」（該当ウィジェットのみ） | 他ウィジェットへ影響しない |
| 未認証でアクセス | — | `/login` にリダイレクト |
| 全ウィジェット同時失敗 | 各ウィジェットに個別エラー表示 | リロードを促すメッセージ |
