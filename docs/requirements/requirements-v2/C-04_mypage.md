# C-04 マイページ — 要件定義 v2（確定版）

> 作成日: 2026-02-20（新規作成）

---

## 概要

ログイン中のユーザーが自分のメールアドレスとパスワードを変更できる画面。
全ロール共通で利用可能。管理者が他ユーザーのパスワードをリセットする機能も提供する。

---

## 機能要件（確定）

| 優先度 | 要件 |
|--------|------|
| Must | ログイン中のユーザーが自分のメールアドレスを変更できる（現在のパスワード確認を必須とする） |
| Must | ログイン中のユーザーが自分のパスワードを変更できる（現在のパスワード＋新しいパスワード×2回入力） |
| Must | パスワードは 8 文字以上、英字・数字をそれぞれ 1 文字以上含むことをバリデーションする |
| Must | 新しいパスワードと確認用パスワードが一致しない場合はエラーを表示する |
| Must | 変更成功後にセッションを再生成する（メールアドレス変更時はセッションを無効化して再ログインを促す） |
| Must | 管理者は他ユーザーのパスワードを新しいパスワードに設定できる（管理者向けリセット機能） |
| Should | 現在のメールアドレスをマスク表示（例: `ya***@example.com`）で確認できる |
| Should | パスワード変更フォームに「表示/非表示」トグルを設ける |

---

## データ要件（確定）

| テーブル | カラム | 操作 |
|---------|--------|------|
| `user_accounts` | `email` | 更新（重複チェック必須） |
| `user_accounts` | `password_hash` | 更新（bcrypt 再ハッシュ） |

**メールアドレス変更フロー（確定）:**
```
1. 現在のパスワードで本人確認
2. 新しいメールアドレスの重複チェック（user_accounts.email UNIQUE）
3. email を更新
4. セッションを無効化 → ログイン画面にリダイレクト（「メールアドレスを変更しました。再ログインしてください。」）
```

**パスワード変更フロー（確定）:**
```
1. 現在のパスワードで本人確認（bcrypt.compare）
2. 新しいパスワードをバリデーション（8文字以上・英数字混在）
3. 新パスワードを bcrypt（コスト 12）でハッシュ化
4. password_hash を更新
5. セッションは継続（パスワード変更後も再ログイン不要）
```

**管理者によるパスワードリセットフロー（確定）:**
```
1. 管理者が対象ユーザーの member_id を指定（M1-02 からも遷移可）
2. 新しいパスワードを入力（確認なしで即時反映可。管理者が仮パスワードを設定）
3. 対象ユーザーの password_hash を更新
```

---

## 非機能要件（確定）

| 区分 | 内容 |
|------|------|
| 性能 | API 応答 500ms 以内 |
| セキュリティ | 認証必須。メールアドレス変更・パスワード変更は必ず現在のパスワードで本人確認（管理者によるリセットを除く）。パスワードは平文でログに出力しない |
| 監査 | メールアドレス変更・パスワード変更を `audit_logs` に記録（変更前後の値は email のみ記録。password_hash は記録しない） |
| ログ | 変更失敗をサーバーログに `WARN` レベルで記録 |

---

## 運用要件

| 項目 | 内容 |
|------|------|
| バックアップ | `user_accounts` テーブルは日次バックアップ対象 |
| パスワードポリシー | 8 文字以上、英字・数字それぞれ 1 文字以上（特殊文字は任意） |
| 管理者リセット | 管理者のみ他ユーザーのパスワードを強制変更できる。変更後のパスワードは管理者がユーザーに別途連絡する |

---

## 受け入れ条件（確定）

- [ ] 正しい現在のパスワードを入力してメールアドレスを変更できる
- [ ] メールアドレス変更後にセッションが無効化され、ログイン画面に遷移する
- [ ] 他のユーザーが使用中のメールアドレスを入力すると「このメールアドレスはすでに使用されています」が表示される
- [ ] 正しい現在のパスワードを入力して新しいパスワードに変更できる
- [ ] 現在のパスワードが誤っている場合「現在のパスワードが正しくありません」が表示される
- [ ] 新しいパスワードが 7 文字以下の場合「8 文字以上で入力してください」が表示される
- [ ] 新しいパスワードと確認用パスワードが一致しない場合「パスワードが一致しません」が表示される
- [ ] 管理者が他ユーザーのパスワードをリセットできる
- [ ] `audit_logs` にメールアドレス変更・パスワード変更のレコードが追加されている

---

## ページ配置

- **ヘッダーのユーザーアイコン → ドロップダウン →「アカウント設定」** からアクセス
- URL: `/mypage` または `/settings/account`
- M1-02 の管理者向け「パスワードリセット」ボタンからも管理者リセット画面に遷移可
