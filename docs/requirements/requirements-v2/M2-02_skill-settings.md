# M2-02 スキル設定 — 要件定義 v2（確定版）

> 作成日: 2026-02-20 | v1 → v2 更新

---

## v1 からの変更点

| 区分 | 内容 |
|------|------|
| データ要件 | テーブル名を物理名に統一。削除前チェックのSQLを明記 |
| 非機能要件 | 確定値に更新 |
| 運用要件 | セクション新設 |

---

## 機能要件（確定）

| 優先度 | 要件 |
|--------|------|
| Must | スキルカテゴリを追加・編集・削除できる |
| Must | スキル項目を追加・編集・削除できる（カテゴリに紐づける） |
| Must | カテゴリ名はシステム内で一意（`skill_categories.name` の UNIQUE 制約） |
| Must | スキル名はカテゴリ内で一意（`skills` の UNIQUE(category_id, name) 制約） |
| Must | 評価データが存在するスキル項目は削除できない |
| Must | 管理者以外はこの画面にアクセスできない（403） |
| Should | カテゴリとスキル項目をドラッグ&ドロップで並べ替え、`display_order` を変更できる |
| Could | カテゴリ・スキル項目の説明文（`description`）を設定できる |

---

## データ要件（確定）

| テーブル | カラム | 制約 |
|---------|--------|------|
| `skill_categories` | `id`, `name`, `description`, `display_order` | `name`: 最大 50 文字・UNIQUE |
| `skills` | `id`, `name`, `description`, `category_id`, `display_order` | `name`: 最大 100 文字・UNIQUE(category_id, name) |
| `member_skills` | `skill_id` | スキル削除前の参照チェックに使用 |

**削除前チェック SQL（確定）:**
```sql
-- スキル削除前チェック
SELECT COUNT(*) FROM member_skills WHERE skill_id = :skillId;
-- 1以上なら削除拒否

-- カテゴリ削除前チェック
SELECT COUNT(*) FROM skills WHERE category_id = :categoryId;
-- 1以上なら削除拒否（まずスキルを削除してからカテゴリ削除）
```

---

## 非機能要件（確定）

| 区分 | 内容 |
|------|------|
| 性能 | 追加・編集・削除操作は 200ms 以内 |
| セキュリティ | 管理者ロールのみアクセス可（サーバー側検証） |
| 監査 | カテゴリ・スキルの追加・編集・削除を `audit_logs` に記録 |
| ログ | バリデーションエラー・DB エラーをサーバーログに記録 |
| 可用性 | 並べ替え（display_order更新）は楽観的 UI 更新を使用し、失敗時はロールバック |

---

## 運用要件

| 項目 | 内容 |
|------|------|
| バックアップ | `skill_categories` / `skills` は日次バックアップ対象 |
| データ保持 | 評価データのあるスキルは削除不可。廃止スキルは `display_order` を最大値にして実質非表示にする運用も可 |
| 権限運用 | スキルカテゴリ・スキル項目の管理は管理者のみ |

---

## 受け入れ条件（確定）

- [ ] 管理者が新規カテゴリを追加できる
- [ ] カテゴリ名が重複する場合「同名のカテゴリがすでに存在します」が表示される
- [ ] 管理者が新規スキル項目をカテゴリに追加できる
- [ ] 評価データが存在するスキルを削除しようとすると「このスキルには評価データが存在するため削除できません」が表示される
- [ ] 評価データがないスキルは削除できる
- [ ] ドラッグ&ドロップで並べ替え後に保存すると `display_order` が更新される
- [ ] 管理者以外でアクセスすると 403 が返る
- [ ] カテゴリ・スキルの変更後に `audit_logs` にレコードが追加されている
