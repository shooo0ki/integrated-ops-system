# IPO（Input-Process-Output）整理

> 作成日: 2026-02-18
> 参照元: docs/requirements/requirements-v1/*.md

---

## IPO 一覧

| # | フロー名 | 画面 |
|---|---------|------|
| 1 | OAuth ログイン | C-01 |
| 2 | ダッシュボード表示 | C-02 |
| 3 | メンバー一覧・検索 | M1-01 |
| 4 | メンバー登録・編集 | M1-03 |
| 5 | スキルマトリクス表示 | M2-01 |
| 6 | スキル評価入力 | M2-03 |
| 7 | プロジェクト登録・編集 | M3-03 |
| 8 | アサイン管理 | M3-04 |
| 9 | 打刻（出勤・退勤） | M4-03 |
| 10 | 月末締め・給与集計 | M5-01 |
| 11 | 請求書生成・配布 | M5-02 |
| 12 | PJ別PL（損益）入力・集計 | M6-01 |

---

## 1. OAuth ログイン（C-01）

### Input
| 入力元 | 項目 |
|--------|------|
| ユーザー操作 | Slack / Google ログインボタン選択 |
| OAuth プロバイダー | アクセストークン、メールアドレス、プロバイダー種別 |
| DB（USER_ACCOUNT） | メールアドレス、ロール、OAuthプロバイダー種別 |

### Process
1. OAuth 2.0 認可フロー開始（state パラメータ生成・CSRF 保護）
2. プロバイダーからコールバック受信（code → token 交換）
3. プロバイダーからメールアドレス取得
4. `USER_ACCOUNT` テーブルでメール照合
5. 照合成功 → セッション生成（user_id, member_id, role, email, expires_at）
6. セッション Cookie 設定（HttpOnly / Secure / SameSite=Lax）
7. 認証ログ記録（メール・タイムスタンプ・IPアドレス）

### Output
| 出力先 | 結果 |
|--------|------|
| ブラウザ | セッション Cookie（有効期限 24h） |
| 画面遷移 | 成功 → C-02 ダッシュボード |
| 画面遷移 | 未登録メール → ログイン画面（エラーメッセージ表示） |
| サーバーログ | 認証成功・失敗ログ |

### 例外
| 条件 | 挙動 |
|------|------|
| 未登録メールでの認証 | セッション未生成・エラーメッセージ表示 |
| OAuthプロバイダー側エラー | エラーログ記録・ログイン画面に戻す |
| セッション期限切れ | ログイン画面リダイレクト・期限切れメッセージ |
| ネットワーク障害 | 一般エラーメッセージ・リトライ案内 |

---

## 2. ダッシュボード表示（C-02）

### Input
| 入力元 | 項目 |
|--------|------|
| セッション | user_id, role |
| DB（ATTENDANCE） | 当日の出退勤記録、未打刻メンバー |
| DB（PROJECT / PROJECT_ASSIGNMENT） | 進行中PJ一覧、担当PJ |
| DB（PL_RECORD） | 全社粗利（当月） |
| DB（INVOICE） | 月末締め確認待ち人数 |

### Process
1. ロール判定（管理者 / マネージャー / 社員・インターン）
2. ロールに応じたウィジェット取得 API を並列実行
3. 各ウィジェットデータを独立して取得・描画（一部失敗しても継続）
4. ナビゲーションカードをロール権限でフィルタリング
5. アクセスログ記録

### Output
| 出力先 | 結果 |
|--------|------|
| 画面 | ロール別ウィジェット（打刻状態・PJ一覧・粗利・締め状況） |
| 画面 | ナビゲーションカード（権限内のみリンク有効） |
| サーバーログ | ダッシュボードアクセスログ |

### 例外
| 条件 | 挙動 |
|------|------|
| ウィジェットデータ取得失敗 | 該当ウィジェットのみエラー表示、他は正常表示 |
| 未認証でアクセス | ログイン画面にリダイレクト |

---

## 3. メンバー一覧・検索（M1-01）

### Input
| 入力元 | 項目 |
|--------|------|
| ユーザー操作 | 検索キーワード（氏名・メール）、フィルター（ステータス・会社・ロール） |
| セッション | role |
| DB（MEMBER） | id, name, profile_image_url, status, company, joined_at |
| DB（USER_ACCOUNT） | email, role |

### Process
1. ロール判定（管理者 / それ以外）
2. フリーワード部分一致検索（氏名 or メール）
3. フィルター条件で AND 絞り込み
4. ロールに応じた列制御（管理者: 全列 / インターン: 氏名のみ）
5. サーバー側でロール別レスポンス生成

### Output
| 出力先 | 結果 |
|--------|------|
| 画面 | メンバーカード一覧（ロール別表示） |
| 画面 | 管理者のみ「新規追加」ボタン表示 |
| サーバーログ | 閲覧ログ |

### 例外
| 条件 | 挙動 |
|------|------|
| 検索結果0件 | 「該当するメンバーが見つかりません」メッセージ |
| データ取得失敗 | エラートースト + リトライボタン |
| プロフィール画像読み込み失敗 | デフォルトアバター表示 |

---

## 4. メンバー登録・編集（M1-03）

### Input
| 入力元 | 項目 |
|--------|------|
| ユーザー（管理者） | name, email, phone, address, status, role, salary_type, salary_amount, company, joined_at, left_at, 銀行口座情報, profile_image |
| ユーザー（社員/インターン本人） | name, phone, address, 銀行口座情報のみ |
| セッション | user_id, role |

### Process
1. ロール権限チェック（管理者 or 本人のみ、マネージャーは403）
2. バリデーション実行
   - メールアドレス一意チェック
   - 時給制の場合：住所・銀行口座情報必須チェック
   - 退社日 ≥ 入社日チェック
   - 画像：JPEG/PNG・5MB以内チェック
3. 銀行口座情報を AES-256 で暗号化
4. DB 保存（新規 or 更新）
5. 監査ログ記録（変更前後の値）

### Output
| 出力先 | 結果 |
|--------|------|
| DB（MEMBER / USER_ACCOUNT） | メンバーレコード保存 |
| 画面遷移 | 成功 → M1-02 詳細 or M1-01 一覧 |
| 監査ログ | 誰が・いつ・何を変更したか（変更前後） |

### 例外
| 条件 | 挙動 |
|------|------|
| メール重複 | 「このメールアドレスはすでに登録されています」・保存中断 |
| 時給制で住所空 | バリデーションエラー・保存中断 |
| 退社日 < 入社日 | バリデーションエラー・保存中断 |
| 5MB超の画像 / 非対応形式 | アップロード中断 |
| DB保存失敗 | エラーメッセージ・サーバーログ記録 |
| マネージャーがアクセス | 403 |

---

## 5. スキルマトリクス表示（M2-01）

### Input
| 入力元 | 項目 |
|--------|------|
| ユーザー操作 | フィルター（スキルカテゴリ・最低レベル・所属会社） |
| セッション | user_id, role, member_id |
| DB（MEMBER） | id, name, company |
| DB（SKILL_CATEGORY / SKILL） | id, name, display_order |
| DB（MEMBER_SKILL） | member_id, skill_id, level, evaluated_at |

### Process
1. ロール判定（インターン: 自分の行のみ / それ以外: 全員）
2. フィルター条件適用（カテゴリ・最低レベル・会社）
3. マトリクス生成（行: メンバー / 列: スキル）
4. 最終更新日計算（MEMBER_SKILL.evaluated_at の最大値）
5. 3ヶ月以上未更新メンバーをオレンジ強調フラグ付与
6. セル色分け（1=グレー / 2=黄 / 3=緑 / 4=青 / 5=紫）

### Output
| 出力先 | 結果 |
|--------|------|
| 画面 | スキルマトリクス（色分け・未評価=「—」） |
| 画面 | 3ヶ月超未更新メンバーのオレンジ強調 |

### 例外
| 条件 | 挙動 |
|------|------|
| スキル項目が0件 | 「スキルが未登録です。M2-02 でスキルを追加してください」 |
| データ取得失敗 | エラートースト・リロード案内 |
| インターンが他メンバー行にアクセス | サーバー側で除外 |

---

## 6. スキル評価入力（M2-03）

### Input
| 入力元 | 項目 |
|--------|------|
| ユーザー（管理者・マネージャー） | 対象メンバー、スキル、level（1〜5）、evaluated_at（過去日以内）、memo |
| セッション | user_id, role, member_id |
| DB（MEMBER_SKILL） | 評価履歴（時系列） |
| DB（PROJECT_ASSIGNMENT） | 担当PJメンバー（マネージャー権限チェック用） |

### Process
1. 権限チェック（管理者: 全員 / マネージャー: 担当PJメンバーのみ / 社員・インターン: 閲覧のみ）
2. バリデーション（レベル必須・評価日は当日以前）
3. 評価レコードを追記（上書きではなく履歴保持）
4. 最新レベル = evaluated_at 最大のレコード
5. 監査ログ記録（評価者・対象・スキル・前後レベル・日時）

### Output
| 出力先 | 結果 |
|--------|------|
| DB（MEMBER_SKILL） | 評価レコード追記 |
| 画面 | 最新レベル更新・評価履歴に追加 |
| 監査ログ | 評価変更ログ |

### 例外
| 条件 | 挙動 |
|------|------|
| レベル未選択で保存 | 「レベルを選択してください」・保存中断 |
| 評価日が未来日 | バリデーションエラー・保存中断 |
| マネージャーが担当外メンバーにアクセス | 403 |
| DB保存失敗 | エラーメッセージ・サーバーログ記録 |

---

## 7. プロジェクト登録・編集（M3-03）

### Input
| 入力元 | 項目 |
|--------|------|
| ユーザー（管理者・マネージャー） | name, description, status, company, start_date, end_date, client_name, contract_type, monthly_contract_amount |
| ユーザー | ポジション定義（position_name, required_count, required_skills） |
| セッション | user_id, role |
| DB（PROJECT_ASSIGNMENT） | アサイン有無（ポジション削除チェック用） |

### Process
1. 権限チェック（管理者: 全PJ / マネージャー: 担当PJのみ / 社員・インターン: 403）
2. バリデーション（end_date ≥ start_date / 必須項目）
3. アサインありポジション削除チェック（削除不可）
4. PJレコード保存（基本情報 + ポジション定義）
5. 監査ログ記録

### Output
| 出力先 | 結果 |
|--------|------|
| DB（PROJECT / PROJECT_POSITION） | PJレコード保存 |
| 画面遷移 | 成功 → M3-02 プロジェクト詳細 |
| 監査ログ | 変更前後ログ |

### 例外
| 条件 | 挙動 |
|------|------|
| 終了日 < 開始日 | バリデーションエラー・保存中断 |
| アサインありポジション削除 | 「アサイン済みのポジションは削除できません」 |
| 社員・インターンがアクセス | 403 |
| DB保存失敗 | エラーメッセージ・サーバーログ記録 |

---

## 8. アサイン管理（M3-04）

### Input
| 入力元 | 項目 |
|--------|------|
| ユーザー（管理者・マネージャー） | member_id, position_id, workload_hours, start_date, end_date |
| ユーザー操作 | スキルフィルタートグル（充足のみ / 全員） |
| セッション | user_id, role |
| DB（MEMBER_SKILL） | member_id, skill_id, level（充足判定用） |
| DB（POSITION_REQUIRED_SKILL） | position_id, skill_id, min_level |
| DB（PROJECT_ASSIGNMENT） | 既存アサイン・工数合計 |

### Process
1. 権限チェック（管理者: 全PJ / マネージャー: 担当PJのみ / 社員・インターン: 403）
2. 重複アサインチェック（同一PJ・同一ポジション）
3. スキル充足判定（MEMBER_SKILL.level ≥ POSITION_REQUIRED_SKILL.min_level 全スキル）
4. 月間工数合計計算（全アクティブアサインの合計）
5. アサインレコード登録 or 解除（終了日設定）
6. 監査ログ記録

### Output
| 出力先 | 結果 |
|--------|------|
| DB（PROJECT_ASSIGNMENT） | アサインレコード作成 or 終了日設定 |
| 画面 | メンバー候補テーブル（スキル充足状況・工数合計） |
| 監査ログ | アサイン登録・解除ログ |

### 例外
| 条件 | 挙動 |
|------|------|
| 重複アサイン | 「このメンバーはすでにこのポジションにアサイン済みです」 |
| 月間工数が0以下 | 「工数は1時間以上を入力してください」 |
| マネージャーが担当外PJにアクセス | 403 |
| DB保存失敗 | エラーメッセージ・サーバーログ記録 |

---

## 9. 打刻（出勤・退勤）（M4-03）

### Input
| 入力元 | 項目 |
|--------|------|
| ユーザー（全ロール・本人のみ） | 出勤時: todo_today / 退勤時: break_minutes, done_today, todo_tomorrow |
| システム | 現在時刻（clock_in / clock_out） |
| セッション | member_id |
| DB（ATTENDANCE） | 当日のレコード有無（二重出勤チェック） |

### Process
1. 本人確認（セッションの member_id でサーバー検証）
2. 出勤フロー:
   - todo_today 必須チェック
   - 当日レコード有無チェック（二重出勤防止）
   - ATTENDANCE レコード作成（clock_in = NOW()）
   - Slack 通知非同期送信（失敗でも打刻は記録）
3. 退勤フロー:
   - 必須項目チェック（break_minutes / done_today / todo_tomorrow）
   - ATTENDANCE レコード更新（clock_out = NOW()）
   - 実働時間計算: (clock_out − clock_in) の分数 − break_minutes
   - Slack 通知非同期送信
4. 監査ログ記録

### Output
| 出力先 | 結果 |
|--------|------|
| DB（ATTENDANCE） | 出勤 / 退勤レコード保存 |
| 画面 | 勤務サマリー（退勤後: 出勤・退勤・実働時間） |
| Slack | 出勤・退勤通知（非同期） |
| 監査ログ | 打刻記録ログ |

### 例外
| 条件 | 挙動 |
|------|------|
| 「今日やること」未入力で出勤 | バリデーションエラー・打刻中断 |
| 二重出勤 | 「本日はすでに出勤済みです」 |
| 退勤時必須項目未入力 | 各項目にエラー表示・打刻中断 |
| Slack通知失敗 | トースト表示（打刻は正常記録） |
| DB保存失敗 | エラーメッセージ・サーバーログ記録 |

---

## 10. 月末締め・給与集計（M5-01）

### Input
| 入力元 | 項目 |
|--------|------|
| ユーザー（管理者のみ） | 集計実行操作、Slack送信操作、強制確定操作、請求書生成操作 |
| DB（ATTENDANCE） | member_id, date, work_minutes, status |
| DB（MEMBER） | id, name, salary_type, salary_amount |
| DB（INVOICE） | 既存請求書レコード |

### Process
1. 権限チェック（管理者のみ / それ以外 403）
2. 集計実行:
   - 時給制メンバーの当月勤怠データを集計
   - 未打刻日チェック → 警告ダイアログ表示
   - 勤務時間合計・給与見込み計算
3. Slack 確認依頼一括送信（未確認メンバーへメンション付き）
4. 確認状態管理（未送信 → 確認待ち → 確認済み / 修正依頼中）
5. 強制確定操作 → 確認済みに強制変更
6. 請求書一括生成 → INVOICE レコード作成
7. 監査ログ記録

### Output
| 出力先 | 結果 |
|--------|------|
| 画面 | 時給制メンバー一覧（確認状況・未打刻日数） |
| DB（INVOICE） | 請求書レコード生成 |
| Slack | 確認依頼メッセージ（メンション付き） |
| 監査ログ | 集計実行・強制確定・請求書生成ログ |

### 例外
| 条件 | 挙動 |
|------|------|
| 未打刻日ありで集計実行 | 警告ダイアログ（続行 or キャンセル選択） |
| Slack送信失敗 | エラートースト + 個別再送ボタン |
| 集計処理失敗 | エラーメッセージ・サーバーログ記録 |
| 管理者以外がアクセス | 403 |

---

## 11. 請求書生成・配布（M5-02）

### Input
| 入力元 | 項目 |
|--------|------|
| ユーザー（管理者 / 本人） | 対象月フィルター、メンバーフィルター（管理者のみ）、ダウンロード / 再生成 / Slack再送 操作 |
| DB（INVOICE） | 請求書一覧（invoice_number, member_id, target_month, work_hours_total, unit_price, amount_excl_tax, amount_incl_tax, file_path） |
| DB（ATTENDANCE） | 再生成時の最新勤怠データ |

### Process
1. 権限チェック（管理者: 全員 / 社員・インターン: 本人分のみ）
2. 一覧取得（対象月・メンバーでフィルタリング）
3. ダウンロード: ストレージから xlsx ファイル取得
4. 再生成（管理者のみ）:
   - 最新勤怠データ取得
   - 計算: 税抜 = 実働時間 × 時給 / 税込 = 税抜 × 1.1
   - xlsx ファイル生成（請求書番号: YYYY-MM-{連番}）
   - INVOICE レコード更新
5. Slack DM 再送信
6. 監査ログ記録

### Output
| 出力先 | 結果 |
|--------|------|
| ブラウザ | xlsx ファイルダウンロード |
| DB（INVOICE） | 再生成レコード更新 |
| Slack | 本人へ DM 送信 |
| 監査ログ | ダウンロード・再生成・Slack送信ログ |

### 例外
| 条件 | 挙動 |
|------|------|
| ファイルが存在しない | 「請求書が見つかりません。再生成してください」 |
| Slack再送失敗 | エラートースト・手動対応案内 |
| 再生成失敗 | エラーメッセージ・サーバーログ記録 |
| 権限外の請求書への直接アクセス | 403 |

---

## 12. PJ別PL（損益）入力・集計（M6-01）

### Input
| 入力元 | 項目 |
|--------|------|
| ユーザー（管理者・マネージャー） | PJ選択、対象月選択、revenue_contract, revenue_extra, cost_outsourcing, cost_other |
| DB（PL_RECORD） | 既存PL手動入力値 |
| DB（PROJECT_ASSIGNMENT） | workload_hours（工数比率計算用） |
| DB（MEMBER） | salary_type, salary_amount |
| DB（ATTENDANCE） | work_minutes（時給制人件費計算用） |

### Process
1. 権限チェック（管理者: 全PJ / マネージャー: 担当PJのみ / 社員・インターン: 403）
2. 勤怠集計済み確認（未集計の場合は警告表示）
3. 人件費自動計算:
   - 月額固定: `月額報酬 × (当該PJ工数 / 全PJ合計工数)`
   - 時給制: `勤怠実績時間 × 時給`
4. 損益計算:
   - 売上合計 = revenue_contract + revenue_extra
   - コスト合計 = 人件費 + cost_outsourcing + cost_other
   - 粗利 = 売上合計 − コスト合計
   - 粗利率 = 粗利 / 売上合計（売上0の場合は「—」）
5. 手動入力値を PL_RECORD に保存
6. 監査ログ記録

### Output
| 出力先 | 結果 |
|--------|------|
| 画面 | 月次損益テーブル（売上・コスト・粗利・粗利率） |
| DB（PL_RECORD） | 手動入力値保存 |
| 監査ログ | PL変更前後ログ |

### 例外
| 条件 | 挙動 |
|------|------|
| 勤怠未集計月 | 「勤怠データが未集計です。M5-01 で集計後に確認してください」・人件費セルに「未集計」表示 |
| 売上が0の場合の粗利率 | 「—」表示（ゼロ除算回避） |
| マネージャーが担当外PJにアクセス | 403 |
| DB保存失敗 | エラーメッセージ・サーバーログ記録 |

---

## 補足: 共通パターン

### 権限制御（全フロー共通）
| ロール | 制御内容 |
|--------|---------|
| 管理者 | 全操作可能 |
| マネージャー | 担当PJ・担当メンバー範囲内のみ |
| 社員 | 閲覧 + 本人情報のみ編集 |
| インターン | 閲覧制限あり + 本人情報のみ編集 |

> **権限チェックはクライアント側の表示制御と独立して、必ずサーバー側でも検証する。**

### 監査ログ（書き込み系フロー共通）
- 記録内容: 操作者・タイムスタンプ・対象レコード・変更前後の値
- 記録先: サーバーサイド監査ログ（DB or ログストレージ）

---

次は `/design-data` でデータ項目一覧（データ辞書）を作成してください。
